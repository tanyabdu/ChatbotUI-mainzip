<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–π –ö–æ–Ω—Ç–µ–Ω—Ç-–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Markdown –ø–∞—Ä—Å–µ—Ä–∞ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Inter:wght@300;500;700&display=swap');
        .font-main { font-family: 'Inter', sans-serif; }
        .font-mystic { font-family: 'Cormorant Garamond', serif; }
        
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #7c3aed; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6d28d9; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .prose h1, .prose h2, .prose h3 { color: #e9d5ff; font-family: 'Cormorant Garamond', serif; margin-top: 1em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #d8b4fe; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–µ–π—Å–∞ */
        .case-card-visual {
            background: linear-gradient(135deg, #2e1065 0%, #0f172a 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç—ã –∞—Ä—Ö–µ—Ç–∏–ø–∞ */
        .archetype-card {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-main p-4 sm:p-8 flex flex-col items-center">

    <div id="app" class="max-w-6xl w-full">
        
        <!-- HEADER (–í—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω) -->
        <header class="text-center mb-12 pt-8 fade-in">
            <h1 class="text-4xl sm:text-6xl font-mystic font-semibold text-purple-300 mb-3 tracking-wide">
                –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≠–ó–û-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥
            </h1>
            <p class="text-purple-400 text-lg sm:text-xl font-light tracking-wider uppercase opacity-80">
                –°—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç ‚Ä¢ –≠–Ω–µ—Ä–≥–∏—è ‚Ä¢ –ü—Ä–æ–¥–∞–∂–∏
            </p>
        </header>

        <!-- NAVIGATION (–í—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞) -->
        <div class="flex flex-wrap justify-center gap-3 sm:gap-4 mb-12 fade-in">
            <button id="navGenerator" class="nav-btn px-5 py-3 rounded-2xl bg-gray-800 text-gray-300 font-bold shadow-lg hover:bg-gray-700 transition-all duration-300 border border-purple-500/20 hover:border-purple-500/50 text-sm sm:text-base flex items-center gap-2">
                <span>üìù</span> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            </button>
            <button id="navArchetype" class="nav-btn px-5 py-3 rounded-2xl bg-gray-800 text-gray-300 font-bold shadow-lg hover:bg-gray-700 transition-all duration-300 border border-purple-500/20 hover:border-purple-500/50 text-sm sm:text-base flex items-center gap-2">
                <span>üß¨</span> –ê—Ä—Ö–µ—Ç–∏–ø —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            </button>
            <button id="navVoice" class="nav-btn px-5 py-3 rounded-2xl bg-gray-800 text-gray-300 font-bold shadow-lg hover:bg-gray-700 transition-all duration-300 border border-purple-500/20 hover:border-purple-500/50 text-sm sm:text-base flex items-center gap-2">
                <span>üéôÔ∏è</span> –ì–æ–ª–æ—Å –ø–æ—Ç–æ–∫–∞
            </button>
            <button id="navCases" class="nav-btn px-5 py-3 rounded-2xl bg-gray-800 text-gray-300 font-bold shadow-lg hover:bg-gray-700 transition-all duration-300 border border-purple-500/20 hover:border-purple-500/50 text-sm sm:text-base flex items-center gap-2">
                <span>üíé</span> –ö–µ–π—Å—ã
            </button>
            <button id="navCalendar" class="nav-btn px-5 py-3 rounded-2xl bg-gray-800 text-gray-300 font-bold shadow-lg hover:bg-gray-700 transition-all duration-300 border border-purple-500/20 hover:border-purple-500/50 text-sm sm:text-base flex items-center gap-2">
                <span>üåô</span> –õ—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            </button>
        </div>

        <!-- –ü–†–ò–í–ï–¢–°–¢–í–ï–ù–ù–´–ô –ë–õ–û–ö (–í–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ) -->
        <section id="welcomeSection" class="text-center py-10 fade-in">
            <div class="inline-block p-8 rounded-full bg-purple-900/20 mb-6 border border-purple-500/30 shadow-[0_0_50px_rgba(124,58,237,0.2)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-purple-300 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
            </div>
            <p class="text-gray-400 text-lg max-w-lg mx-auto">
                –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –º–µ–Ω—é –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –≤–∞—à–∏–º –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ–º.
            </p>
        </section>

        <!-- –°–ï–ö–¶–ò–Ø 1: –ì–ï–ù–ï–†–ê–¢–û–† –ö–û–ù–¢–ï–ù–¢–ê (–°–∫—Ä—ã—Ç–∞) -->
        <section id="generatorSection" class="hidden fade-in">
             <div class="bg-gray-800 p-6 rounded-2xl border border-purple-700/50 mb-10 relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-purple-600 rounded-full blur-3xl opacity-20"></div>
                <div id="archetypeIndicatorGen" class="hidden absolute top-4 right-4 px-3 py-1 bg-purple-900/80 text-purple-200 text-xs rounded-full border border-purple-500/30 flex items-center gap-1">
                    <span>üß¨</span> –ê—Ä—Ö–µ—Ç–∏–ø –∞–∫—Ç–∏–≤–µ–Ω
                </div>
                
                <h2 class="text-2xl font-mystic font-semibold text-purple-200 mb-6 relative z-10">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
                <form id="contentForm" class="space-y-6 relative z-10">
                    <!-- –¶–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">–¶–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <label class="cursor-pointer group">
                                <input type="radio" name="contentGoal" value="sale" class="peer sr-only" checked>
                                <div class="p-4 rounded-xl bg-gray-700 border-2 border-transparent peer-checked:border-purple-500 peer-checked:bg-purple-900/40 transition text-center hover:bg-gray-600 h-full flex flex-col justify-center items-center shadow-lg group-hover:scale-[1.02]">
                                    <div class="text-3xl mb-2">üí∞</div>
                                    <div class="font-bold text-white text-lg">–ü—Ä–æ–¥–∞–∂–∞</div>
                                    <div class="text-xs text-gray-400 mt-1">–ó–∞–ø—É—Å–∫–∏, —É—Å–ª—É–≥–∏, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</div>
                                </div>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="contentGoal" value="engagement" class="peer sr-only">
                                <div class="p-4 rounded-xl bg-gray-700 border-2 border-transparent peer-checked:border-pink-500 peer-checked:bg-pink-900/40 transition text-center hover:bg-gray-600 h-full flex flex-col justify-center items-center shadow-lg group-hover:scale-[1.02]">
                                    <div class="text-3xl mb-2">üî•</div>
                                    <div class="font-bold text-white text-lg">–û—Ö–≤–∞—Ç—ã –∏ –í–æ–≤–ª–µ—á–µ–Ω–∏–µ</div>
                                    <div class="text-xs text-gray-400 mt-1">–õ–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç—ã, –¥–æ–≤–µ—Ä–∏–µ</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="niche" class="block text-sm font-medium text-gray-300 mb-2">–ù–∏—à–∞ –∏ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                            <input type="text" id="niche" placeholder="–ù–∞–ø—Ä: –¢–∞—Ä–æ–ª–æ–≥, –ê—Å—Ç—Ä–æ–ª–æ–≥, –ù—É–º–µ—Ä–æ–ª–æ–≥"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-purple-500/50 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 text-white placeholder-gray-500 transition"
                                   required>
                        </div>
                        <div>
                            <label for="daysCount" class="block text-sm font-medium text-gray-300 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π / –†–µ–∂–∏–º</label>
                            <select id="daysCount" class="w-full p-3 rounded-lg bg-gray-700 border border-purple-500/50 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 text-white transition">
                                <option value="today" class="font-bold text-green-400">‚òÖ –°–µ–≥–æ–¥–Ω—è (–Ø –≤ –ø–æ—Ç–æ–∫–µ)</option>
                                <option value="3">3 –î–Ω—è (–¢–µ—Å—Ç)</option>
                                <option value="7">7 –î–Ω–µ–π (–ù–µ–¥–µ–ª—è)</option>
                                <option value="14">14 –î–Ω–µ–π (–ü—Ä–æ–≥—Ä–µ–≤)</option>
                                <option value="30">30 –î–Ω–µ–π (–ú–µ—Å—è—Ü)</option>
                            </select>
                        </div>
                    </div>

                    <!-- –ü–æ–ª–µ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
                    <div id="productFieldContainer" class="transition-all duration-300">
                        <label for="productDescription" class="block text-sm font-medium text-gray-300 mb-2">–ß—Ç–æ –ø—Ä–æ–¥–∞–µ–º? (–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞)</label>
                        <textarea id="productDescription" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –ø—Ä–æ–¥—É–∫—Ç, –∫—É—Ä—Å –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é..."
                                  class="w-full p-3 rounded-lg bg-gray-700 border border-purple-500/50 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 text-white placeholder-gray-500 transition"
                                  rows="2" required></textarea>
                    </div>

                    <!-- –¢–∏–ø —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
                    <div id="strategyTypeContainer" class="transition-all duration-300">
                        <label for="strategyType" class="block text-sm font-medium text-gray-300 mb-2">–¢–∏–ø –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ü—Ä–æ–¥–∞–∂</label>
                        <select id="strategyType" class="w-full p-3 rounded-lg bg-gray-700 border border-purple-500/50 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 text-white transition">
                            <option value="general">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–≠–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å + –õ–∏—á–Ω–æ—Å—Ç—å + –ü—Ä–æ–¥–∞–∂–∏)</option>
                            <option value="launch">–ü—Ä–æ–≥—Ä–µ–≤ –∫ –∑–∞–ø—É—Å–∫—É (–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—É—Å–∫–∞)</option>
                        </select>
                    </div>

                    <button type="submit" id="generateButton"
                            class="w-full py-4 bg-gradient-to-r from-purple-700 to-indigo-800 hover:from-purple-600 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg transform transition hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed">
                        –°–æ–∑–¥–∞—Ç—å –°—Ç—Ä–∞—Ç–µ–≥–∏—é
                    </button>
                </form>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div id="resultsContainer" class="hidden space-y-8">
                <div class="flex justify-between items-center border-b border-purple-800 pb-4">
                    <h2 class="text-3xl font-mystic text-purple-200">–í–∞—à –ö–æ–Ω—Ç–µ–Ω—Ç-–ü–ª–∞–Ω</h2>
                    <button onclick="window.print()" class="text-gray-400 hover:text-white text-sm flex items-center hover:bg-gray-800 px-3 py-1 rounded transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
                <div id="daysList" class="space-y-6">
                    <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–Ω–µ–π -->
                </div>
            </div>
        </section>

        <!-- –°–ï–ö–¶–ò–Ø 2: –ê–†–•–ï–¢–ò–ü –°–¢–†–ê–¢–ï–ì–ò–ò (–°–∫—Ä—ã—Ç–∞) -->
        <section id="archetypeSection" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- –ë–ª–æ–∫ 1: –¢–µ—Å—Ç / –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
                <div id="archetypeTestBlock" class="lg:col-span-12 bg-gray-800 p-8 rounded-2xl border border-purple-700/50 shadow-2xl">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-mystic text-purple-200 mb-2">–î–ù–ö –í–∞—à–µ–≥–æ –õ–∏—á–Ω–æ–≥–æ –ë—Ä–µ–Ω–¥–∞ üß¨</h2>
                        <p class="text-gray-400">–ü—Ä–æ–π–¥–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É, —á—Ç–æ–±—ã –Ω–µ–π—Ä–æ—Å–µ—Ç—å "–∑–∞–≥–æ–≤–æ—Ä–∏–ª–∞" –≤–∞—à–∏–º –≥–æ–ª–æ—Å–æ–º.</p>
                    </div>

                    <div id="quizContainer" class="max-w-2xl mx-auto space-y-8">
                        <!-- –í–æ–ø—Ä–æ—Å—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
                    </div>

                    <div class="text-center mt-10">
                        <button id="submitQuizBtn" class="px-8 py-4 bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold rounded-xl shadow-lg transform transition hover:scale-105">
                            –†–∞—Å–∫—Ä—ã—Ç—å –º–æ–π –ê—Ä—Ö–µ—Ç–∏–ø
                        </button>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ 2: –†–µ–∑—É–ª—å—Ç–∞—Ç (–ö–∞—Ä—Ç–æ—á–∫–∞ –ê—Ä—Ö–µ—Ç–∏–ø–∞) - —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
                <div id="archetypeResultBlock" class="hidden lg:col-span-12">
                    <div class="archetype-card p-8 rounded-2xl shadow-2xl relative overflow-hidden">
                        <!-- –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç -->
                        <div id="archetypeBg" class="absolute inset-0 opacity-20"></div>
                        
                        <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div>
                                <div class="inline-block px-3 py-1 bg-white/10 rounded-full text-xs text-white mb-4 tracking-widest uppercase">–í–∞—à —Å—Ç–∏–ª—å</div>
                                <h2 id="archetypeTitle" class="text-4xl md:text-5xl font-mystic text-white mb-4 font-bold leading-tight">–ú–∞–≥-–ë—É–Ω—Ç–∞—Ä—å</h2>
                                <p id="archetypeDesc" class="text-gray-300 text-lg mb-6">–ì–ª—É–±–æ–∫–∏–π, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ç–∏–ª—å —Å –Ω–æ—Ç–∫–∞–º–∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–∏.</p>
                                
                                <div class="flex flex-wrap gap-2 mb-6" id="archetypeKeywords">
                                    <!-- –¢–µ–≥–∏ -->
                                </div>

                                <div class="bg-black/30 p-4 rounded-lg border border-white/10">
                                    <h4 class="text-purple-300 text-xs uppercase font-bold mb-2">–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (Tone of Voice)</h4>
                                    <p id="archetypeTone" class="text-sm text-gray-300 italic">...</p>
                                </div>
                            </div>

                            <div class="bg-gray-900/50 p-6 rounded-xl border border-white/10">
                                <h3 class="text-xl font-mystic text-white mb-4">–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–¥</h3>
                                <div class="flex gap-4 mb-6" id="archetypeColors">
                                    <!-- –¶–≤–µ—Ç–∞ -->
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <span class="text-xs text-gray-500 block">–®—Ä–∏—Ñ—Ç—ã</span>
                                        <span id="archetypeFonts" class="text-white text-sm">...</span>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-500 block">–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ (Vibe)</span>
                                        <span id="archetypeVibes" class="text-white text-sm">...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 text-center">
                            <button id="applyArchetypeBtn" class="px-8 py-3 bg-white text-purple-900 font-bold rounded-xl shadow-lg hover:bg-purple-50 transition flex items-center justify-center gap-2 mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å—Ç–∏–ª—å
                            </button>
                            <p class="text-xs text-gray-400 mt-2">–°—Ç–∏–ª—å –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω –∫–æ –≤—Å–µ–º –±—É–¥—É—â–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
                        </div>
                        
                        <button onclick="resetArchetype()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xs underline">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- –°–ï–ö–¶–ò–Ø 3: –ì–û–õ–û–° –ü–û–¢–û–ö–ê (–°–∫—Ä—ã—Ç–∞) -->
        <section id="voiceSection" class="hidden fade-in">
             <div class="max-w-2xl mx-auto text-center">
                <div class="bg-gray-800 p-8 rounded-3xl border-2 border-purple-500/50 shadow-2xl relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-purple-900/20 to-transparent pointer-events-none"></div>
                    <h2 class="text-3xl font-mystic text-white mb-6 relative z-10">üéôÔ∏è –ì–æ–ª–æ—Å –ü–æ—Ç–æ–∫–∞</h2>
                    <p class="text-gray-300 mb-8 relative z-10">–ù–∞–¥–∏–∫—Ç—É–π—Ç–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏. –ò–ò –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç –∏—Ö –≤ –∏–¥–µ–∞–ª—å–Ω—ã–π –ø–æ—Å—Ç.</p>
                    <div class="relative z-10 mb-8">
                        <button id="voiceRecordBtn" class="w-24 h-24 rounded-full bg-gradient-to-br from-red-500 to-pink-600 text-white shadow-xl flex items-center justify-center transition-all transform hover:scale-105 focus:outline-none mx-auto ring-4 ring-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        </button>
                        <p id="voiceStatus" class="text-sm text-gray-400 mt-4">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏</p>
                    </div>
                    <div id="voiceTranscriptContainer" class="hidden text-left mb-6">
                        <label class="text-xs text-gray-500 mb-1 block">–¢–µ–∫—Å—Ç:</label>
                        <div id="voiceTranscript" class="bg-gray-900/50 p-4 rounded-lg text-gray-300 text-sm max-h-32 overflow-y-auto border border-gray-700"></div>
                    </div>
                    <button id="voiceGenerateBtn" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold hidden transition shadow-lg transform hover:scale-[1.02]">‚ú® –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –ü–æ—Å—Ç</button>
                </div>
                <div id="voiceResult" class="mt-8 hidden bg-gray-800 p-6 rounded-2xl border border-gray-700 text-left fade-in shadow-xl">
                    <h3 class="text-xl font-mystic text-purple-300 mb-4">–ì–æ—Ç–æ–≤—ã–π –ü–æ—Å—Ç</h3>
                    <div id="voicePostContent" class="prose prose-invert max-w-none text-sm text-gray-200 whitespace-pre-wrap"></div>
                    <button onclick="copyVoicePost()" class="mt-4 w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-bold transition">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
                </div>
            </div>
        </section>

        <!-- –°–ï–ö–¶–ò–Ø 4: –ö–ï–ô–°–´ (–°–∫—Ä—ã—Ç–∞) -->
        <section id="casesSection" class="hidden fade-in">
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5 space-y-6">
                    <div class="bg-gray-800 p-6 rounded-2xl border border-purple-700/50 shadow-xl">
                        <h2 class="text-2xl font-mystic text-purple-200 mb-4">–°–æ–∑–¥–∞—Ç—å –ö–µ–π—Å</h2>
                        <div class="mb-4"><label class="block text-sm text-purple-300 mb-2">1. –°–∫—Ä–∏–Ω—à–æ—Ç</label><div class="relative border-2 border-dashed border-purple-500/30 rounded-xl p-6 text-center cursor-pointer hover:bg-gray-700/50 transition group"><input type="file" id="reviewImageInput" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*"><div id="uploadPreview" class="text-gray-400 text-sm group-hover:text-white">–ó–∞–≥—Ä—É–∑–∏—Ç—å (JPG, PNG)</div></div><button id="recognizeTextBtn" class="mt-3 w-full py-2 bg-blue-600/20 text-blue-300 rounded-lg text-sm hidden hover:bg-blue-600/40 transition">üëÅÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç</button></div>
                        <div class="mb-4"><label class="block text-sm text-purple-300 mb-2">2. –¢–µ–∫—Å—Ç</label><textarea id="reviewText" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 text-white text-sm focus:border-purple-500 outline-none transition" rows="4"></textarea></div>
                        <div class="space-y-3 mb-6">
                            <div><label class="text-xs text-gray-400 mb-1 block">–ë–´–õ–û</label><input type="text" id="caseBefore" class="w-full p-2 rounded bg-gray-900 border border-gray-700 text-white text-sm focus:border-purple-500 outline-none"></div>
                            <div><label class="text-xs text-gray-400 mb-1 block">–°–î–ï–õ–ê–õ–ò</label><input type="text" id="caseAction" class="w-full p-2 rounded bg-gray-900 border border-gray-700 text-white text-sm focus:border-purple-500 outline-none"></div>
                            <div><label class="text-xs text-gray-400 mb-1 block">–°–¢–ê–õ–û</label><input type="text" id="caseAfter" class="w-full p-2 rounded bg-gray-900 border border-gray-700 text-white text-sm focus:border-purple-500 outline-none"></div>
                        </div>
                        
                        <!-- 4. –¢–µ–≥–∏ -->
                        <div class="mb-6">
                            <label class="block text-sm text-purple-300 mb-2">–¢–µ–≥–∏</label>
                            <div class="flex flex-wrap gap-2 mb-2" id="tagSuggestions">
                                <span class="px-2 py-1 bg-gray-700 rounded text-xs cursor-pointer hover:bg-purple-600 transition" onclick="addTag('–î–µ–Ω—å–≥–∏')">–î–µ–Ω—å–≥–∏</span>
                                <span class="px-2 py-1 bg-gray-700 rounded text-xs cursor-pointer hover:bg-purple-600 transition" onclick="addTag('–û—Ç–Ω–æ—à–µ–Ω–∏—è')">–û—Ç–Ω–æ—à–µ–Ω–∏—è</span>
                                <span class="px-2 py-1 bg-gray-700 rounded text-xs cursor-pointer hover:bg-purple-600 transition" onclick="addTag('–ó–¥–æ—Ä–æ–≤—å–µ')">–ó–¥–æ—Ä–æ–≤—å–µ</span>
                                <span class="px-2 py-1 bg-gray-700 rounded text-xs cursor-pointer hover:bg-purple-600 transition" onclick="addTag('–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ')">–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</span>
                            </div>
                            <input type="text" id="caseTags" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter" class="w-full p-2 rounded bg-gray-900 border border-gray-700 text-white text-sm focus:border-purple-500 outline-none">
                            <div id="selectedTagsContainer" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>

                        <button id="generateCaseBtn" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl shadow-lg hover:shadow-purple-500/30 transition transform hover:scale-[1.02]">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div class="lg:col-span-7 space-y-6">
                    <div id="casePreviewBlock" class="hidden bg-gray-800 p-6 rounded-2xl border-2 border-purple-500 relative shadow-2xl"><button onclick="this.parentElement.classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button><h3 class="text-xl font-mystic text-white mb-4">–ì–æ—Ç–æ–≤—ã–π –ö–µ–π—Å ‚ú®</h3><div class="space-y-4 mb-6"><div><label class="text-xs text-gray-400">–ó–∞–≥–æ–ª–æ–≤–∫–∏</label><div id="generatedHeadlines" class="space-y-2 mt-1"></div></div><div><label class="text-xs text-gray-400">–¶–∏—Ç–∞—Ç–∞</label><blockquote id="generatedQuote" class="border-l-4 border-purple-500 pl-4 italic text-gray-300 my-2 bg-gray-900/50 p-3 rounded-r"></blockquote></div><div><label class="text-xs text-gray-400">–¢–µ–∫—Å—Ç</label><div id="generatedBody" class="bg-gray-900 p-4 rounded-lg text-sm text-gray-200 whitespace-pre-wrap h-64 overflow-y-auto custom-scrollbar border border-gray-700"></div></div></div><div class="flex gap-3"><button id="saveCaseBtn" class="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold shadow-lg transition">üíæ –í –ë–∏–±–ª–∏–æ—Ç–µ–∫—É</button><button id="copyCaseBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button><button id="createVisualBtn" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg transition shadow-lg" title="–°–æ–∑–¥–∞—Ç—å –º–∞–∫–µ—Ç">üé® –ú–∞–∫–µ—Ç</button></div></div>
                    <div class="bg-gray-800 p-6 rounded-2xl border border-purple-700/30"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-mystic text-purple-200">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2><div class="flex gap-2"><input type="text" id="searchCases" placeholder="–ü–æ–∏—Å–∫..." class="bg-gray-900 border border-gray-700 text-white text-xs rounded-lg px-3 py-2 w-24 focus:w-40 transition-all outline-none focus:border-purple-500"><select id="filterTags" class="bg-gray-900 border border-gray-700 text-white text-xs rounded-lg px-3 py-2 outline-none focus:border-purple-500"><option value="all">–í—Å–µ —Ç–µ–≥–∏</option></select></div></div><div id="casesLibraryList" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto custom-scrollbar"></div></div>
                </div>
            </div>
        </section>

        <!-- –°–ï–ö–¶–ò–Ø 5: –õ–£–ù–ù–´–ô –ö–ê–õ–ï–ù–î–ê–†–¨ (–°–∫—Ä—ã—Ç–∞) -->
        <section id="calendarSection" class="hidden fade-in">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-purple-700/50 text-center relative overflow-hidden">
                <div class="absolute -top-20 -left-20 w-60 h-60 bg-blue-900 rounded-full blur-[100px] opacity-30"></div>
                <h2 class="text-3xl font-mystic text-purple-200 mb-2">–≠–Ω–µ—Ä–≥–∏–∏ –°–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –î–Ω—è</h2>
                <p id="currentDateDisplay" class="text-gray-400 mb-6 text-lg border-b border-purple-800 pb-2 inline-block"></p>
                <div id="moonContent" class="hidden mt-2">
                    <div class="flex flex-col items-center justify-center mb-8"><div class="w-32 h-32 rounded-full bg-gradient-to-tr from-gray-200 to-gray-400 shadow-[0_0_40px_rgba(255,255,255,0.3)] flex items-center justify-center relative overflow-hidden mb-4 border-4 border-purple-500/20"><div class="absolute inset-0 bg-black/10 rounded-full transform -translate-x-4 translate-y-2 filter blur-md"></div><span id="moonDayNumber" class="text-5xl font-mystic font-bold text-gray-800 relative z-10 drop-shadow-md"></span></div><div class="text-center"><h3 id="moonPhaseName" class="text-2xl text-white font-bold"></h3><p id="moonZodiac" class="text-purple-300 font-medium mt-1 text-lg tracking-wide uppercase"></p></div></div>
                    <div class="bg-gray-900/60 p-6 rounded-xl border-l-4 border-purple-500 mb-8 text-left max-w-3xl mx-auto shadow-lg"><div id="moonDescription" class="text-gray-200 text-lg leading-relaxed font-mystic italic"></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left max-w-4xl mx-auto"><div class="bg-gray-800/80 p-5 rounded-xl border border-green-500/30 shadow-inner"><h4 class="text-green-400 font-bold mb-3 uppercase tracking-wider text-sm">‚úÖ –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ</h4><ul id="moonGoodList" class="text-gray-300 text-sm space-y-2 list-disc list-inside"></ul></div><div class="bg-gray-800/80 p-5 rounded-xl border border-red-500/30 shadow-inner"><h4 class="text-red-400 font-bold mb-3 uppercase tracking-wider text-sm">‚õî –ù–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ</h4><ul id="moonBadList" class="text-gray-300 text-sm space-y-2 list-disc list-inside"></ul></div></div>
                </div>
                <div id="moonLoader" class="py-10"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500 mx-auto"></div><p class="mt-4 text-purple-300 animate-pulse">–°—á–∏—Ç—ã–≤–∞—é –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–≤–µ–∑–¥...</p></div>
            </div>
        </section>

        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <!-- Visual Modal -->
        <div id="visualModal" class="hidden fixed inset-0 bg-gray-900/95 z-50 flex items-center justify-center p-4"><div class="bg-gray-800 border border-purple-500 rounded-2xl w-full max-w-md relative p-6 shadow-2xl"><button onclick="this.parentElement.parentElement.classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-black/50 rounded-full w-8 h-8">‚úï</button><div id="visualCanvas" class="case-card-visual p-6 rounded-xl aspect-[4/5] flex flex-col justify-between relative overflow-hidden"><div class="relative z-10"><h2 class="text-2xl font-bold text-white mb-4" id="visualTitle"></h2><p class="text-lg text-purple-100 italic" id="visualQuote"></p></div><div class="relative z-10 mt-4 grid grid-cols-3 gap-2 text-xs text-center"><div class="bg-white/10 p-2 rounded backdrop-blur-sm">–ë–´–õ–û<br><span id="visualBefore" class="font-bold"></span></div><div class="bg-white/10 p-2 rounded backdrop-blur-sm">–°–î–ï–õ–ê–õ–ò<br><span id="visualAction" class="font-bold"></span></div><div class="bg-purple-500/20 p-2 rounded border border-purple-500/50 backdrop-blur-sm text-purple-200">–°–¢–ê–õ–û<br><span id="visualAfter" class="font-bold"></span></div></div></div><p class="text-center text-xs text-gray-500 mt-4">–°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç</p></div></div>
        
        <!-- Loading -->
        <div id="loading" class="hidden fixed inset-0 bg-gray-900/90 z-50 flex items-center justify-center backdrop-blur-sm"><div class="text-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500 mx-auto mb-4"></div><p id="loadingText" class="text-xl font-mystic text-purple-200 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div></div>
        
        <!-- Error -->
        <div id="errorContainer" class="hidden fixed bottom-4 right-4 bg-red-900/90 border border-red-500 p-4 rounded-lg z-50 text-sm text-red-200 shadow-xl"></div>
        
        <!-- Personalize Modal -->
        <div id="personalizeModal" class="hidden fixed inset-0 bg-gray-900/95 z-50 flex items-center justify-center p-4 backdrop-blur-md"><div class="bg-gray-800 border border-purple-500/50 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative p-8"><button onclick="closePersonalizeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button><h3 class="text-2xl font-mystic text-purple-300 mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ "–ü–æ–¥ –°–µ–±—è" ü™Ñ</h3><div id="questionsContainer" class="space-y-6 mb-8"></div><div class="flex justify-end gap-4"><button onclick="closePersonalizeModal()" class="text-gray-400 hover:text-white transition">–û—Ç–º–µ–Ω–∞</button><button id="confirmPersonalizeBtn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">‚ú® –°–æ–∑–¥–∞—Ç—å</button></div></div></div>

    </div>

    <script type="module">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API Key

        // Elements
        const navGenerator = document.getElementById('navGenerator');
        const navVoice = document.getElementById('navVoice');
        const navCases = document.getElementById('navCases');
        const navCalendar = document.getElementById('navCalendar');
        const navArchetype = document.getElementById('navArchetype');
        
        const sections = {
            generator: document.getElementById('generatorSection'),
            voice: document.getElementById('voiceSection'),
            cases: document.getElementById('casesSection'),
            calendar: document.getElementById('calendarSection'),
            archetype: document.getElementById('archetypeSection')
        };
        
        // Landing
        const welcomeSection = document.getElementById('welcomeSection');

        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const errorContainer = document.getElementById('errorContainer');
        const archetypeIndicatorGen = document.getElementById('archetypeIndicatorGen');

        // --- QUESTIONS FOR ARCHETYPE TEST ---
        const archetypeQuestions = [
            {
                q: "–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ —Ä–∞–±–æ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º?",
                a: ["–î–∞—Ç—å –∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —á–µ—Ç–∫–∏–π –ø–ª–∞–Ω (–ü—Ä–∞–≤–∏—Ç–µ–ª—å)", "–ü–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è, –≤—ã—Å–ª—É—à–∞—Ç—å –∏ —É—Ç–µ—à–∏—Ç—å (–ó–∞–±–æ—Ç–ª–∏–≤—ã–π)", "–í–¥–æ—Ö–Ω–æ–≤–∏—Ç—å –Ω–∞ –±–æ–ª—å—à–∏–µ –ø–µ—Ä–µ–º–µ–Ω—ã –∏ –º–∞–≥–∏—é (–ú–∞–≥)", "–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–¥—É, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ –∂–µ—Å—Ç–∫–∞—è (–ë—É–Ω—Ç–∞—Ä—å)"]
            },
            {
                q: "–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ –ø—Ä–∞–≤–∏–ª–∞–º –∏ —Ç—Ä–∞–¥–∏—Ü–∏—è–º –≤ —ç–∑–æ—Ç–µ—Ä–∏–∫–µ?",
                a: ["–ß—Ç—É —Ç—Ä–∞–¥–∏—Ü–∏–∏, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä—É—é –∏—Ö (–ú—É–¥—Ä–µ—Ü)", "–°–æ–∑–¥–∞—é —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–¢–≤–æ—Ä–µ—Ü)", "–°–æ–±–ª—é–¥–∞—é —Å—Ç—Ä–æ–≥–æ, —ç—Ç–æ –±–∞–∑–∞ (–ü—Ä–∞–≤–∏—Ç–µ–ª—å)", "–õ—é–±–ª—é –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∏ —à–æ–∫–∏—Ä–æ–≤–∞—Ç—å (–®—É—Ç)"]
            },
            {
                q: "–ö–∞–∫–∞—è —Ñ—Ä–∞–∑–∞ –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—à –ø–æ–¥—Ö–æ–¥?",
                a: ["–í—Å—ë –±—É–¥–µ—Ç —Ç–∞–∫, –∫–∞–∫ —Ç—ã –∑–∞—Ö–æ—á–µ—à—å (–ú–∞–≥)", "–Ø –∑–Ω–∞—é, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏ –Ω–∞—É—á—É —Ç–µ–±—è (–£—á–∏—Ç–µ–ª—å/–ú—É–¥—Ä–µ—Ü)", "–î–∞–≤–∞–π –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ–º —Å–æ–±–æ–π (–°–ª–∞–≤–Ω—ã–π –º–∞–ª—ã–π)", "–ú—ã –≤–º–µ—Å—Ç–µ –ø—Ä–æ–π–¥–µ–º —ç—Ç–æ—Ç –ø—É—Ç—å (–ì–µ—Ä–æ–π)"]
            },
            {
                q: "–ß–µ–≥–æ –≤—ã –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –±–æ–∏—Ç–µ—Å—å –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –ø–ª–∞–Ω–µ?",
                a: ["–ë—ã—Ç—å —Å–∫—É—á–Ω—ã–º –∏ –æ–±—ã—á–Ω—ã–º (–ë—É–Ω—Ç–∞—Ä—å)", "–ù–∞–≤—Ä–µ–¥–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ –¥–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π —Å–æ–≤–µ—Ç (–ó–∞–±–æ—Ç–ª–∏–≤—ã–π)", "–ü–æ—Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∏—Ç—É–∞—Ü–∏–µ–π (–ü—Ä–∞–≤–∏—Ç–µ–ª—å)", "–û–∫–∞–∑–∞—Ç—å—Å—è –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–º (–ú—É–¥—Ä–µ—Ü)"]
            },
             {
                q: "–ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ–¥–µ–∂–¥—ã –∏–ª–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ –≤–∞–º –±–ª–∏–∂–µ?",
                a: ["–°—Ç—Ä–æ–≥–∏–π, –¥–æ—Ä–æ–≥–æ–π, —Å—Ç–∞—Ç—É—Å–Ω—ã–π (–ü—Ä–∞–≤–∏—Ç–µ–ª—å)", "–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π, –∑–∞–≥–∞–¥–æ—á–Ω—ã–π, –º–∞–Ω—Ç–∏–∏ (–ú–∞–≥)", "–Ø—Ä–∫–∏–π, –Ω–µ–æ–±—ã—á–Ω—ã–π, —ç–ø–∞—Ç–∞–∂–Ω—ã–π (–®—É—Ç/–ë—É–Ω—Ç–∞—Ä—å)", "–£—é—Ç–Ω—ã–π, –º—è–≥–∫–∏–π, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π (–ó–∞–±–æ—Ç–ª–∏–≤—ã–π/–°–ª–∞–≤–Ω—ã–π –º–∞–ª—ã–π)"]
            },
            {
                q: "–ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Å—É–ø–µ—Ä—Å–∏–ª–∞?",
                a: ["–Ø –≤–∏–∂—É –ª—é–¥–µ–π –Ω–∞—Å–∫–≤–æ–∑—å (–ú–∞–≥)", "–Ø —É–º–µ—é —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ö–∞–æ—Å (–ü—Ä–∞–≤–∏—Ç–µ–ª—å)", "–Ø —É–º–µ—é –ª—é–±–∏—Ç—å –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å (–ó–∞–±–æ—Ç–ª–∏–≤—ã–π)", "–Ø —É–º–µ—é –∑–∞—Ä—è–∂–∞—Ç—å —ç–Ω–µ—Ä–≥–∏–µ–π –∏ –≤–µ—Å–µ–ª—å–µ–º (–®—É—Ç)"]
            },
             {
                q: "–ß—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç –ø–æ—Å–ª–µ –æ–±—â–µ–Ω–∏—è —Å –≤–∞–º–∏?",
                a: ["–Ø—Å–Ω–æ—Å—Ç—å –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–ú—É–¥—Ä–µ—Ü)", "–í–æ–ª—à–µ–±—Å—Ç–≤–æ –∏ –≤–µ—Ä—É –≤ —á—É–¥–æ (–ú–∞–≥)", "–û—â—É—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ç–µ–ø–ª–∞ (–ó–∞–±–æ—Ç–ª–∏–≤—ã–π)", "–î—Ä–∞–π–≤ –∏ –∂–µ–ª–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å (–ì–µ—Ä–æ–π)"]
            }
        ];

        // Utils
        function toggleLoading(show, text = "–ó–∞–≥—Ä—É–∑–∫–∞...") { loadingText.textContent = text; loadingDiv.classList.toggle('hidden', !show); }
        function showError(msg) { errorContainer.textContent = msg; errorContainer.classList.remove('hidden'); setTimeout(() => errorContainer.classList.add('hidden'), 4000); }
        async function fetchGemini(payload) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            return await response.json();
        }

        // --- NAVIGATION ---
        function switchTab(tabName) {
            welcomeSection.classList.add('hidden'); // Hide welcome
            Object.values(sections).forEach(sec => sec.classList.add('hidden'));
            [navGenerator, navVoice, navCases, navCalendar, navArchetype].forEach(btn => {
                btn.classList.remove('bg-purple-700', 'text-white', 'ring-2', 'ring-purple-400', 'shadow-none');
                btn.classList.add('bg-gray-800', 'text-gray-300', 'shadow-lg');
            });

            sections[tabName].classList.remove('hidden');
            const activeBtn = document.getElementById(`nav${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            activeBtn.classList.add('bg-purple-700', 'text-white', 'ring-2', 'ring-purple-400');
            activeBtn.classList.remove('bg-gray-800', 'text-gray-300', 'shadow-lg');
            activeBtn.classList.add('shadow-none'); // Pressed effect

            if (tabName === 'calendar') loadMoonData();
            if (tabName === 'cases') renderCasesLibrary();
            if (tabName === 'archetype') checkArchetypeStatus();
        }

        navGenerator.addEventListener('click', () => switchTab('generator'));
        navVoice.addEventListener('click', () => switchTab('voice'));
        navCases.addEventListener('click', () => switchTab('cases'));
        navCalendar.addEventListener('click', () => switchTab('calendar'));
        navArchetype.addEventListener('click', () => switchTab('archetype'));

        // --- TOGGLE FORM LOGIC (Generator) ---
        const goalRadios = document.getElementsByName('contentGoal');
        const productContainer = document.getElementById('productFieldContainer');
        const strategyContainer = document.getElementById('strategyTypeContainer');

        if (goalRadios.length > 0) {
            goalRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isEngagement = e.target.value === 'engagement';
                    if (isEngagement) {
                        productContainer.classList.add('opacity-0', 'h-0', 'overflow-hidden');
                        strategyContainer.classList.add('opacity-0', 'h-0', 'overflow-hidden');
                        document.getElementById('productDescription').removeAttribute('required');
                    } else {
                        productContainer.classList.remove('opacity-0', 'h-0', 'overflow-hidden');
                        strategyContainer.classList.remove('opacity-0', 'h-0', 'overflow-hidden');
                        document.getElementById('productDescription').setAttribute('required', 'true');
                    }
                });
            });
        }

        // --- ARCHETYPE LOGIC ---
        function checkArchetypeStatus() {
            const savedProfile = localStorage.getItem('archetypeProfile');
            if (savedProfile) {
                renderArchetypeResult(JSON.parse(savedProfile));
                document.getElementById('archetypeTestBlock').classList.add('hidden');
                document.getElementById('archetypeResultBlock').classList.remove('hidden');
                archetypeIndicatorGen.classList.remove('hidden');
            } else {
                renderArchetypeTest();
                document.getElementById('archetypeTestBlock').classList.remove('hidden');
                document.getElementById('archetypeResultBlock').classList.add('hidden');
                archetypeIndicatorGen.classList.add('hidden');
            }
        }

        function renderArchetypeTest() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = archetypeQuestions.map((q, idx) => `
                <div class="bg-gray-700/50 p-6 rounded-xl border border-gray-600">
                    <h4 class="text-lg text-white mb-4 font-medium">${idx + 1}. ${q.q}</h4>
                    <div class="space-y-2">
                        ${q.a.map(ans => `
                            <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-600 cursor-pointer transition">
                                <input type="radio" name="q${idx}" value="${ans}" class="form-radio text-purple-600 h-4 w-4">
                                <span class="text-gray-300 text-sm">${ans}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('submitQuizBtn').addEventListener('click', async () => {
            const answers = [];
            let allAnswered = true;
            archetypeQuestions.forEach((_, idx) => {
                const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                if (!selected) allAnswered = false;
                else answers.push(selected.value);
            });

            if (!allAnswered) {
                showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!");
                return;
            }

            toggleLoading(true, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –î–ù–ö –≤–∞—à–µ–≥–æ –±—Ä–µ–Ω–¥–∞...");
            
            try {
                const prompt = `You are a Brand Archetype Expert (Pearson-Marr system).
                Analyze these quiz answers from an esoteric expert: ${JSON.stringify(answers)}.
                
                Task:
                1. Determine top 3 archetypes.
                2. Create a Brand Voice profile.
                3. Generate a system instruction snippet for future AI content generation.
                
                Output strictly JSON:
                {
                  "top_archetypes": ["Name 1", "Name 2", "Name 3"],
                  "description": "Short description of this combination in Russian",
                  "brand_voice": {
                    "tone": "Description of tone in Russian",
                    "keywords": ["word1", "word2", "word3", "word4", "word5"]
                  },
                  "visual_guide": {
                    "colors": ["Hex1", "Hex2", "Hex3"],
                    "fonts": "Font recommendation in Russian",
                    "vibes": "Vibe description in Russian"
                  },
                  "system_instruction_snippet": "You are writing for an expert with archetypes [Names]. Tone: [Tone]. Keywords: [Keywords]. Avoid: cliches. Style: [Description]."
                }`;

                const payload = { contents: [{ parts: [{ text: "Analyze archetypes." }] }], systemInstruction: { parts: [{ text: prompt }] }, generationConfig: { responseMimeType: "application/json" } };
                const data = await fetchGemini(payload);
                const profile = JSON.parse(data.candidates[0].content.parts[0].text);
                
                localStorage.setItem('archetypeProfile', JSON.stringify(profile));
                checkArchetypeStatus();
                showError("–ê—Ä—Ö–µ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª–µ–Ω! üß¨");

            } catch (e) { console.error(e); showError("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞."); } 
            finally { toggleLoading(false); }
        });

        function renderArchetypeResult(profile) {
            document.getElementById('archetypeTitle').textContent = profile.top_archetypes.join(' + ');
            document.getElementById('archetypeDesc').textContent = profile.description;
            
            const keywordsHtml = profile.brand_voice.keywords.map(k => `<span class="px-2 py-1 bg-purple-900/50 rounded text-purple-200 text-xs border border-purple-500/30">#${k}</span>`).join('');
            document.getElementById('archetypeKeywords').innerHTML = keywordsHtml;
            
            document.getElementById('archetypeTone').textContent = profile.brand_voice.tone;
            
            const colorsHtml = profile.visual_guide.colors.map(c => `<div class="w-8 h-8 rounded-full shadow-md border border-white/20" style="background-color: ${c}" title="${c}"></div>`).join('');
            document.getElementById('archetypeColors').innerHTML = colorsHtml;
            
            document.getElementById('archetypeFonts').textContent = profile.visual_guide.fonts;
            document.getElementById('archetypeVibes').textContent = profile.visual_guide.vibes;
        }

        document.getElementById('applyArchetypeBtn').addEventListener('click', () => {
            switchTab('generator');
            showError("–°—Ç–∏–ª—å –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç.");
        });

        window.resetArchetype = () => {
            if(confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞?")) {
                localStorage.removeItem('archetypeProfile');
                checkArchetypeStatus();
            }
        };

        // --- HELPER: GET SYSTEM PROMPT WITH ARCHETYPE ---
        function getSystemPromptWithArchetype(basePrompt) {
            const profile = JSON.parse(localStorage.getItem('archetypeProfile'));
            if (profile && profile.system_instruction_snippet) {
                return `${basePrompt}\n\n**IMPORTANT - BRAND VOICE SETTINGS:**\n${profile.system_instruction_snippet}\nApply this tone strictly.`;
            }
            return basePrompt;
        }

        // --- MOON CALENDAR LOGIC ---
        let moonLoaded = false;
        async function loadMoonData() {
            if(moonLoaded) return;
            const today = new Date().toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('currentDateDisplay').textContent = today;

            try {
                const systemPrompt = `You are an expert Astrologer.
                Task: Analyze the current date (${today}). Determine the Moon Phase, Moon Day, and the Zodiac Sign the Moon is currently in.
                Then write a specific "Energy of the Day" advice in Russian using this EXACT style/format:
                "–ß—Ç–æ –º–æ–∂–Ω–æ –∏ –Ω–µ–ª—å–∑—è [Date] –ø–æ –õ—É–Ω–µ: [Actionable advice]. –ù–µ –∏–¥–∏—Ç–µ [warning], –¥–∞–∂–µ –µ—Å–ª–∏ [reason related to Moon sign]. –ü—É—Å—Ç—å –≤–∞—à–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç [type of activity]. –¢–∞–∫ –≤—ã –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ [Moon phase] —ç–Ω–µ—Ä–≥–∏—é. [Closing advice/affirmation]."
                
                Output strictly JSON:
                {
                    "moonDay": number,
                    "phaseName": "string (e.g. –†–∞—Å—Ç—É—â–∞—è –õ—É–Ω–∞)",
                    "zodiacSign": "string (e.g. –õ—É–Ω–∞ –≤ –û–≤–Ω–µ)",
                    "description": "string (The styled text described above)",
                    "good": ["list", "of", "3", "things", "to do"],
                    "bad": ["list", "of", "3", "things", "to avoid"]
                }`;

                const payload = { 
                    contents: [{ parts: [{ text: `–°–µ–≥–æ–¥–Ω—è ${today}. –î–∞–π –ø—Ä–æ–≥–Ω–æ–∑.` }] }], 
                    systemInstruction: { parts: [{ text: systemPrompt }] }, 
                    generationConfig: { responseMimeType: "application/json" } 
                };
                
                const data = await fetchGemini(payload);
                const res = JSON.parse(data.candidates[0].content.parts[0].text);
                
                document.getElementById('moonDayNumber').textContent = res.moonDay;
                document.getElementById('moonPhaseName').textContent = res.phaseName;
                document.getElementById('moonZodiac').textContent = res.zodiacSign;
                document.getElementById('moonDescription').textContent = res.description;
                
                document.getElementById('moonGoodList').innerHTML = res.good.map(i => `<li>${i}</li>`).join('');
                document.getElementById('moonBadList').innerHTML = res.bad.map(i => `<li>${i}</li>`).join('');
                
                document.getElementById('moonLoader').classList.add('hidden');
                document.getElementById('moonContent').classList.remove('hidden');
                moonLoaded = true;
            } catch(e) { console.error(e); }
        }

        // --- VOICE LOGIC ---
        const voiceRecordBtn = document.getElementById('voiceRecordBtn');
        const voiceGenerateBtn = document.getElementById('voiceGenerateBtn');
        let recognition, isRecording = false, finalTranscript = '';

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onstart = () => { isRecording = true; voiceRecordBtn.classList.add('recording-pulse'); };
            recognition.onend = () => { isRecording = false; voiceRecordBtn.classList.remove('recording-pulse'); if(finalTranscript) voiceGenerateBtn.classList.remove('hidden'); };
            recognition.onresult = (e) => {
                let interim = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
                    else interim += e.results[i][0].transcript;
                }
                document.getElementById('voiceTranscript').textContent = finalTranscript + interim;
            };
            voiceRecordBtn.onclick = () => { if(isRecording) recognition.stop(); else recognition.start(); };
        }

        voiceGenerateBtn.onclick = async () => {
            toggleLoading(true, "–ü–∏—à—É –ø–æ—Å—Ç...");
            try {
                let basePrompt = `Copywriter. Turn transcript into post. Russian. Structure: Hook -> Body -> CTA. NO EMOJIS.`;
                const fullPrompt = getSystemPromptWithArchetype(basePrompt); // Apply Archetype
                
                const data = await fetchGemini({ contents: [{ parts: [{ text: `Transcript: ${finalTranscript}` }] }], systemInstruction: { parts: [{ text: fullPrompt }] } });
                document.getElementById('voicePostContent').innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
                document.getElementById('voiceResult').classList.remove('hidden');
            } catch(e) { showError("–û—à–∏–±–∫–∞"); } finally { toggleLoading(false); }
        };
        
        window.copyVoicePost = () => { navigator.clipboard.writeText(document.getElementById('voicePostContent').innerText); showError("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); };

        // --- CASES LOGIC ---
        const reviewImageInput = document.getElementById('reviewImageInput');
        let currentImageBase64 = null;

        reviewImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                currentImageBase64 = reader.result.split(',')[1];
                document.getElementById('recognizeTextBtn').classList.remove('hidden');
                document.getElementById('uploadPreview').textContent = `üì∏ ${file.name}`;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('recognizeTextBtn').onclick = async () => {
            toggleLoading(true, "OCR...");
            try {
                const payload = { contents: [{ parts: [{ text: "Transcribe text." }, { inlineData: { mimeType: "image/jpeg", data: currentImageBase64 } }] }] };
                const data = await fetchGemini(payload);
                document.getElementById('reviewText').value = data.candidates[0].content.parts[0].text;
            } catch(e) { showError("–û—à–∏–±–∫–∞ OCR"); } finally { toggleLoading(false); }
        };

        const generateCaseBtn = document.getElementById('generateCaseBtn');
        let currentGeneratedCase = null;

        generateCaseBtn.onclick = async () => {
            const text = document.getElementById('reviewText').value;
            const before = document.getElementById('caseBefore').value;
            const action = document.getElementById('caseAction').value;
            const after = document.getElementById('caseAfter').value;
            
            toggleLoading(true, "–£–ø–∞–∫–æ–≤—ã–≤–∞—é...");
            try {
                let basePrompt = `Marketing Expert. Create Case Study JSON: { "headlines": ["H1", "H2", "H3"], "quote": "Quote", "body": "Text PSR" }. Russian. NO EMOJIS.`;
                const fullPrompt = getSystemPromptWithArchetype(basePrompt); // Apply Archetype

                const query = `Review: ${text}\nBefore: ${before}\nAction: ${action}\nResult: ${after}`;
                const payload = { contents: [{ parts: [{ text: query }] }], systemInstruction: { parts: [{ text: fullPrompt }] }, generationConfig: { responseMimeType: "application/json" } };
                const data = await fetchGemini(payload);
                const res = JSON.parse(data.candidates[0].content.parts[0].text);
                
                currentGeneratedCase = { ...res, before, action, after, tags: [...selectedTags] }; // Added tags
                document.getElementById('generatedHeadlines').innerHTML = res.headlines.map(h => `<div class="p-2 bg-gray-700 border rounded cursor-pointer hover:border-purple-500" onclick="selectHeadline('${h}')">${h}</div>`).join('');
                document.getElementById('generatedQuote').textContent = res.quote;
                document.getElementById('generatedBody').textContent = res.body;
                document.getElementById('casePreviewBlock').classList.remove('hidden');
            } catch(e) { showError("–û—à–∏–±–∫–∞"); } finally { toggleLoading(false); }
        };

        window.selectHeadline = (h) => currentGeneratedCase.selectedHeadline = h;
        
        document.getElementById('saveCaseBtn').onclick = () => {
            const cases = JSON.parse(localStorage.getItem('cases') || '[]');
            cases.unshift(currentGeneratedCase);
            localStorage.setItem('cases', JSON.stringify(cases));
            renderCasesLibrary();
            document.getElementById('casePreviewBlock').classList.add('hidden');
        };
        
        // Tagging System
        const caseTagsInput = document.getElementById('caseTags');
        const selectedTagsContainer = document.getElementById('selectedTagsContainer');
        let selectedTags = [];

        window.addTag = (tag) => {
            if (!selectedTags.includes(tag)) {
                selectedTags.push(tag);
                renderTags();
            }
        };

        caseTagsInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = e.target.value.trim();
                if (tag) { addTag(tag); e.target.value = ''; }
            }
        });

        function renderTags() {
            selectedTagsContainer.innerHTML = selectedTags.map(tag => 
                `<span class="bg-purple-600 text-white px-2 py-1 rounded text-xs flex items-center gap-1">
                    #${tag} <button onclick="removeTag('${tag}')" class="hover:text-red-300">√ó</button>
                </span>`
            ).join('');
        }
        window.removeTag = (tag) => { selectedTags = selectedTags.filter(t => t !== tag); renderTags(); };


        function renderCasesLibrary() {
            const cases = JSON.parse(localStorage.getItem('cases') || '[]');
            const container = document.getElementById('casesLibraryList');
            const filter = document.getElementById('filterTags').value;
            const search = document.getElementById('searchCases').value.toLowerCase();

            // Update filter options
            const allTags = [...new Set(cases.flatMap(c => c.tags || []))];
            const filterSelect = document.getElementById('filterTags');
            // Re-populate filter options to avoid duplicates and include new tags
            filterSelect.innerHTML = '<option value="all">–í—Å–µ —Ç–µ–≥–∏</option>';
             allTags.forEach(t => filterSelect.add(new Option(t, t)));
            filterSelect.value = filter; // Restore selection

            const filtered = cases.filter(c => {
                const matchesTag = filter === 'all' || (c.tags && c.tags.includes(filter));
                const matchesSearch = (c.selectedHeadline + c.body + c.quote).toLowerCase().includes(search);
                return matchesTag && matchesSearch;
            });

            container.innerHTML = filtered.length ? filtered.map(c => `
                <div class="bg-gray-700 p-4 rounded-xl border border-gray-600 relative group">
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="navigator.clipboard.writeText('${c.body}')" class="p-1 bg-gray-800 rounded hover:text-purple-300">üìã</button>
                    </div>
                     <div class="flex gap-1 mb-2 flex-wrap">${(c.tags || []).map(t=>`<span class="text-[10px] bg-gray-800 px-1 rounded text-purple-300">#${t}</span>`).join('')}</div>
                    <h4 class="font-bold text-white mb-2">${c.selectedHeadline || c.headlines[0]}</h4>
                    <p class="text-xs text-gray-300 italic mb-2">"${c.quote}"</p>
                    <p class="text-xs text-gray-400 line-clamp-3">${c.body}</p>
                </div>`).join('') : '<div class="col-span-full text-center text-gray-500">–ù–µ—Ç –∫–µ–π—Å–æ–≤</div>';
        }
        
        document.getElementById('searchCases').addEventListener('input', renderCasesLibrary);
        document.getElementById('filterTags').addEventListener('change', renderCasesLibrary);


        document.getElementById('createVisualBtn').onclick = () => {
             document.getElementById('visualTitle').textContent = currentGeneratedCase.selectedHeadline || currentGeneratedCase.headlines[0];
             document.getElementById('visualQuote').textContent = `"${currentGeneratedCase.quote}"`;
             document.getElementById('visualBefore').textContent = currentGeneratedCase.before;
             document.getElementById('visualAction').textContent = currentGeneratedCase.action;
             document.getElementById('visualAfter').textContent = currentGeneratedCase.after;
             document.getElementById('visualModal').classList.remove('hidden');
        };

        // --- PERSONALIZATION & MAIN GENERATOR ---
        window.closePersonalizeModal = () => { personalizeModal.classList.add('hidden'); currentPersonalizeData = null; };
        
        const contentForm = document.getElementById('contentForm');
        const daysList = document.getElementById('daysList');

        contentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const niche = document.getElementById('niche').value;
            const days = document.getElementById('daysCount').value;
            const goal = document.querySelector('input[name="contentGoal"]:checked').value;
            const product = document.getElementById('productDescription').value;

            if (!niche || (goal === 'sale' && !product)) { showError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!"); return; }

            toggleLoading(true, "–°–æ–∑–¥–∞—é...");
            document.getElementById('resultsContainer').classList.add('hidden');
            daysList.innerHTML = '';

            try {
                const kb = `KNOWLEDGE: Runes (safety, gratitude, dangerous tattoos, cleaning negatives), Ba-zi/Numerology (dates, health, compatibility, child talents), Chakras/Psychology (energy leaks, victim mentality, self-love, money blocks, burnout, alcohol family scripts), Tarot (myths, decision making, relationship crisis), T-Games (fullness, femininity, assertiveness), Astro (retrogrades, solstices, eclipses). Formats: Guess the fact, Direct message breakdown, My ritual, Client story.`;
                let basePrompt = `Expert Content Strategist. Create content plan JSON: {days: [{day, title, theses}]}. Niche: ${niche}. Product: ${product}. Days: ${days}. ${kb}. NO EMOJIS.`;
                const fullPrompt = getSystemPromptWithArchetype(basePrompt); // Apply Archetype

                const query = `Goal: ${goal}. Generate.`;

                const data = await fetchGemini({ contents: [{ parts: [{ text: query }] }], systemInstruction: { parts: [{ text: fullPrompt }] }, generationConfig: { responseMimeType: "application/json" } });
                const plan = JSON.parse(data.candidates[0].content.parts[0].text);
                
                plan.days.forEach(day => {
                    const div = document.createElement('div');
                    div.className = "bg-gray-800 p-4 rounded border border-gray-700";
                    div.innerHTML = `<h3 class="text-xl text-white">–î–µ–Ω—å ${day.day}: ${day.title}</h3><p class="text-gray-400 mb-2">${day.theses}</p>
                    <div class="flex gap-2"><button class="px-3 py-1 bg-purple-600 rounded text-xs text-white" onclick="genDetail('stories', '${day.title}', '${day.theses}')">–°—Ç–æ—Ä–∏—Å</button><button class="px-3 py-1 bg-blue-600 rounded text-xs text-white" onclick="genDetail('telegram', '${day.title}', '${day.theses}')">Telegram</button></div>
                    <div class="mt-2 text-sm text-gray-300 whitespace-pre-wrap output-area"></div>`;
                    daysList.appendChild(div);
                });
                document.getElementById('resultsContainer').classList.remove('hidden');
            } catch(e) { showError("–û—à–∏–±–∫–∞"); } finally { toggleLoading(false); }
        });

        window.genDetail = async (type, title, theses) => {
            let basePrompt = `Copywriter. Write ${type} for "${title}". Theses: ${theses}. Russian. NO EMOJIS.`;
            const fullPrompt = getSystemPromptWithArchetype(basePrompt); // Apply Archetype
            
            const data = await fetchGemini({ contents: [{ parts: [{ text: "Write." }] }], systemInstruction: { parts: [{ text: fullPrompt }] } });
            event.target.parentElement.nextElementSibling.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
        };
        
        // Init: Check archetype status on load
        checkArchetypeStatus();
        renderCasesLibrary();

    </script>
</body>
</html>
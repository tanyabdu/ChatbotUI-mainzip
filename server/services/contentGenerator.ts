import OpenAI from "openai";

let client: OpenAI | null = null;

function getClient(): OpenAI {
  if (!client) {
    client = new OpenAI({
      baseURL: "https://api.deepseek.com/v1",
      apiKey: process.env.DEEPSEEK_API_KEY,
    });
  }
  return client;
}

export interface ContentGenerationInput {
  goal: "sale" | "engagement";
  niche: string;
  days: number;
  product?: string;
  strategy?: "general" | "launch";
  archetype?: {
    name: string;
    description: string;
    recommendations: string[];
    triggerWords?: string[];
    contentStyle?: string[];
    tone?: string;
  };
}

export interface FormatContent {
  content: string;
  hashtags: string[];
}

export interface GeneratedContentDay {
  day: number;
  idea: string;
  type: string;
  post: FormatContent;
  carousel: FormatContent;
  reels: FormatContent;
  stories: FormatContent;
}

function fixHashtagsArray(jsonStr: string): string {
  // Find hashtags arrays and fix unquoted values
  // Pattern: "hashtags": [ ... ]
  return jsonStr.replace(/"hashtags"\s*:\s*\[([^\]]*)\]/g, (match, arrayContent) => {
    // Split by comma, but be careful with quoted strings
    const items: string[] = [];
    let current = '';
    let inQuotes = false;
    
    for (const char of arrayContent) {
      if (char === '"' && (current.length === 0 || current[current.length - 1] !== '\\')) {
        inQuotes = !inQuotes;
        current += char;
      } else if (char === ',' && !inQuotes) {
        if (current.trim()) {
          items.push(current.trim());
        }
        current = '';
      } else {
        current += char;
      }
    }
    if (current.trim()) {
      items.push(current.trim());
    }
    
    // Fix each item
    const fixedItems = items.map(item => {
      item = item.trim();
      // Already properly quoted
      if (item.startsWith('"') && item.endsWith('"')) {
        return item;
      }
      // Single quoted - convert to double
      if (item.startsWith("'") && item.endsWith("'")) {
        return `"${item.slice(1, -1)}"`;
      }
      // Unquoted hashtag or text - add quotes
      return `"${item.replace(/"/g, '\\"')}"`;
    });
    
    return `"hashtags": [${fixedItems.join(', ')}]`;
  });
}

function cleanJsonResponse(content: string): string {
  // Remove markdown code blocks if present
  let cleaned = content.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
  
  // Fix hashtags arrays specifically
  cleaned = fixHashtagsArray(cleaned);
  
  // Fix trailing commas before closing brackets
  cleaned = cleaned.replace(/,\s*([}\]])/g, '$1');
  
  return cleaned;
}

function parseContentResponse(content: string): GeneratedContentDay[] {
  // Try to extract JSON array from response
  const jsonMatch = content.match(/\[[\s\S]*\]/);
  if (!jsonMatch) {
    console.error("No JSON array found in response:", content.substring(0, 500));
    throw new Error("Invalid response format from AI");
  }
  
  let jsonStr = jsonMatch[0];
  
  // First attempt: parse as-is
  try {
    return JSON.parse(jsonStr) as GeneratedContentDay[];
  } catch (e) {
    console.log("First parse attempt failed, trying to clean JSON...");
  }
  
  // Second attempt: clean and parse
  try {
    const cleaned = cleanJsonResponse(jsonStr);
    return JSON.parse(cleaned) as GeneratedContentDay[];
  } catch (e) {
    console.log("Second parse attempt failed, trying line-by-line fix...");
  }
  
  // Third attempt: try to fix line by line
  try {
    // More aggressive: try to manually reconstruct valid JSON
    let fixed = jsonStr;
    
    // Fix common issues with hashtags arrays
    // Match "hashtags": [ and everything until ]
    const hashtagPattern = /"hashtags"\s*:\s*\[([^\]]+)\]/g;
    fixed = fixed.replace(hashtagPattern, (match, content) => {
      // Split on commas that are not inside quotes
      const parts = content.split(',').map((p: string) => {
        p = p.trim();
        // Remove leading/trailing whitespace and newlines
        p = p.replace(/^[\s\n]+|[\s\n]+$/g, '');
        
        // If starts with # and not in quotes, quote it
        if (p.startsWith('#') && !p.startsWith('"')) {
          return `"${p}"`;
        }
        // If in quotes, keep as is
        if (p.startsWith('"') && p.endsWith('"')) {
          return p;
        }
        // Otherwise wrap in quotes
        if (p && !p.startsWith('"')) {
          return `"${p}"`;
        }
        return p;
      }).filter((p: string) => p.length > 0);
      
      return `"hashtags": [${parts.join(', ')}]`;
    });
    
    // Remove trailing commas
    fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
    
    return JSON.parse(fixed) as GeneratedContentDay[];
  } catch (e) {
    console.error("All parse attempts failed. Error:", e);
    console.error("Raw content sample:", jsonStr.substring(0, 500));
    throw new Error("Failed to parse AI response as JSON");
  }
}

export async function generateContentStrategy(input: ContentGenerationInput): Promise<GeneratedContentDay[]> {
  const { goal, niche, days, product, strategy, archetype } = input;
  
  const strategyDescription = strategy === "launch"
    ? "ะกัััะบัััะฐ ะทะฐะฟััะบะฐ: ะฟัะตะดะทะฐะฟััะบ โ ะพัะบัััะธะต โ ะดะตะดะปะฐะนะฝั โ ะทะฐะบัััะธะต"
    : "ะกะฑะฐะปะฐะฝัะธัะพะฒะฐะฝะฝัะน ะผะธะบั: ัะบัะฟะตััะฝัะน ะบะพะฝัะตะฝั + ะปะธัะฝัะต ะธััะพัะธะธ + ะผัะณะบะธะต ะฟัะพะดะฐะถะธ";
    
  const archetypeInstruction = archetype 
    ? `\n\nะะะ ะะะะะะ (ะะะฏะะะขะะะฌะะ ััะธััะฒะฐะน ะฒ ััะธะปะต ัะตะบััะฐ!):
ะััะตัะธะฟ: ${archetype.name}
ะะฟะธัะฐะฝะธะต ััะธะปั: ${archetype.description}
${archetype.tone ? `ะขะพะฝะฐะปัะฝะพััั: ${archetype.tone}` : ''}
${archetype.triggerWords?.length ? `ะกะปะพะฒะฐ-ััะธะณะณะตัั (ะธัะฟะพะปัะทัะน ะฒ ัะตะบััะฐั): ${archetype.triggerWords.slice(0, 10).join(", ")}` : ''}
${archetype.contentStyle?.length ? `ะกัะธะปั ะบะพะฝัะตะฝัะฐ: ${archetype.contentStyle.join("; ")}` : ''}
ะะปััะตะฒัะต ัะปะพะฒะฐ ะฑัะตะฝะดะฐ: ${archetype.recommendations.join(", ")}

ะะะะะ: ะะธัะธ ะฒ ััะธะปะต ะฐััะตัะธะฟะฐ "${archetype.name}". ะัะฟะพะปัะทัะน ัะพะพัะฒะตัััะฒัััะธะน ัะพะฝ, ัะปะพะฒะฐ-ััะธะณะณะตัั ะธ ะฝะฐัััะพะตะฝะธะต. ะะพะฝัะตะฝั ะดะพะปะถะตะฝ ะทะฒััะฐัั ะบะฐะบ ะฑัะดัะพ ะตะณะพ ะฟะธัะฐะป ัะตะปะพะฒะตะบ ั ััะธะผ ะฐััะตัะธะฟะพะผ.`
    : "";

  // Viral content rules - based on engagement psychology
  const writingStyleRules = `
ะะะะะะะ ะะะะะะะ: ะะตัะฒะพะต ะฟัะตะดะปะพะถะตะฝะธะต โ ะะะฎะงะะ. ะงะตะปะพะฒะตะบ ะดะพะปะถะตะฝ ะพััะฐะฝะพะฒะธัั ัะบัะพะปะป.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ะคะะะะฃะะซ ะะะะฃะกะะซะฅ ะฅะฃะะะ (ะธัะฟะพะปัะทัะน ะธั!):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ะจะะ/ะะะะขะะะะะะกะะฏ:
   "ะะพัะตะผั ั ะฑะพะปััะต ะฝะต ะดะตะปะฐั ัะฐัะบะปะฐะดั ะฝะฐ ะปัะฑะพะฒั"
   "ะฏ ะฟะพัะตััะปะฐ 50 ะบะปะธะตะฝัะพะฒ ะทะฐ ะผะตััั. ะ ััะพ ะปัััะตะต, ััะพ ัะปััะธะปะพัั"
   "3 ะฒะตัะธ, ะบะพัะพััะต ัะฐัะพะปะพะณะธ ัะบััะฒะฐัั ะพั ะบะปะธะตะฝัะพะฒ"

2. ะฃะะะะะะะะ ะกะะะฏ:
   "ะัะปะธ ัั ัะพะดะธะปะฐัั ะฒ ััะธ ะดะฐัั โ ะพััะพัะพะถะฝะพ ะฒ ะฑะปะธะถะฐะนัะธะน ะผะตััั"
   "ะญัะพั ะทะฝะฐะบ ะฟัะธััะณะธะฒะฐะตั ัะพะบัะธัะฝัั ะผัะถัะธะฝ. ะัะพะฒะตัั ัะฒะพะน"
   "ะขั ะดะตะปะฐะตัั ััะพ ะบะฐะถะดะพะต ัััะพ. ะ ัะตััะตัั ัะฝะตัะณะธั ะดะพ ะฒะตัะตัะฐ"

3. ะะะะะะะะงะะะะะฏ ะะซะกะะฌ (ะพัะบัััะฐั ะฟะตัะปั):
   "ะะฐััั ะฟะพะบะฐะทะฐะปะธ ะตะน ัะฐะทะฒะพะด. ะะพ ะพะฝะฐ ัะดะตะปะฐะปะฐ ะพะดะฝั ะฒะตัั ะธ..."
   "ะััั ัะปะพะฒะพ, ะบะพัะพัะพะต ะฝะตะปัะทั ะณะพะฒะพัะธัั ะฝะฐ ัะฐัััััั ะัะฝั. ะญัะพ..."
   "90% ะปัะดะตะน ะฝะต ะทะฝะฐัั ััะพะณะพ ะฟัะพ ัะฒะพะน ะทะฝะฐะบ. ะ ััะพ ะผะตะฝัะตั ะฒัั"

4. ะกะะะกะะ ะก ะฆะะคะะะะ:
   "5 ะทะฝะฐะบะพะฒ, ััะพ ะฟะพััะฐ ัะถะต ัะฐะฑะพัะฐะตั"
   "3 ะพัะธะฑะบะธ ะฒ ัะตััะพะณัะฐะด, ะบะพัะพััะต ะดะตะปะฐัั ะฒัะต"
   "7 ัะปะพะฒ, ะบะพัะพััะต ะฟัะธััะณะธะฒะฐัั ะดะตะฝัะณะธ"

5. ะะะะกะะะะะะะะฆะะฏ:
   "ะะฐะฟะธัะธ ัะฒะพะน ะทะฝะฐะบ โ ัะบะฐะถั, ััะพ ะถะดัั ะฒ ะฑะปะธะถะฐะนัะธะน ะผะตััั"
   "ะะตัะฒะฐั ะฑัะบะฒะฐ ะธะผะตะฝะธ ัะฐััะบะฐะถะตั ะพ ัะฒะพะตะน ะบะฐัะผะต"
   "ะัะฑะตัะธ ะบะฐััั โ ะฟะพะปััะธัั ะฟะพัะปะฐะฝะธะต"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐พ ะขะะะะะะะซ ะกะะฅะะะะะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- "ะกะพััะฐะฝะธ, ััะพะฑั ะฝะต ะฟะพัะตัััั"
- "ะจะฟะฐัะณะฐะปะบะฐ ะดะปั ะทะฝะฐะบะพะฒ โ ะฟัะธะณะพะดะธััั"
- "ะะฐะปะตะฝะดะฐัั ะฑะปะฐะณะพะฟัะธััะฝัั ะดะฝะตะน โ ะทะฐะฑะธัะฐะน"
- ะัะฑัะต ะฟะพะปะตะทะฝัะต ัะฟะธัะบะธ, ะดะฐัั, ัะตะบะปะธััั

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฌ ะขะะะะะะะซ ะะะะะะะขะะะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะกะฟะพัะฝัะต ััะฒะตัะถะดะตะฝะธั: "ะะฐะบะธ โ ัะฐะผัะน ัะปะพะถะฝัะน ะทะฝะฐะบ ะฒ ะพัะฝะพัะตะฝะธัั. ะกะพะณะปะฐัะฝั?"
- ะัะฑะพั: "ะขั ะะตะดัะผะฐ ะธะปะธ ะัะธัะฐ? ะะธัะธ ะฒ ะบะพะผะผะตะฝัั"
- ะะธัะฝัะน ะพะฟัั: "ะ ั ัะตะฑั ัะฐะบ ะฑัะปะพ? ะะฐััะบะฐะถะธ"
- ะฃะณะฐะดะฐะนะบะธ: "ะฃะณะฐะดะฐะน, ะบะฐะบะพะน ะทะฝะฐะบ ัะฐะผัะน ะฑะพะณะฐััะน?"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฑ ะกะขะะฃะะขะฃะะ ะะะะก (15-30 ัะตะบ):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
0-3 ัะตะบ: ะจะะ-ััะบ (ะพััะฐะฝะพะฒะธัั ัะบัะพะปะป)
3-20 ัะตะบ: ะะฐัะบัััะธะต + ะฟะพะปัะทะฐ
20-30 ัะตะบ: ะัะธะทัะฒ (ะฟะพะดะฟะธัะบะฐ/ะบะพะผะผะตะฝั/ัะพััะฐะฝะตะฝะธะต)

ะัะธะผะตัั ััะบะพะฒ ะดะปั ัะธะปั:
"ะกัะพะฟ! ะัะปะธ ัั ะกะบะพัะฟะธะพะฝ โ ััะพ ะดะปั ัะตะฑั"
"ะฏ ัะทะฝะฐะปะฐ ััะพ ะธ ะพัะธะณะตะปะฐ"
"ะะธะบะพะณะดะฐ ะฝะต ะดะตะปะฐะน ััะพะณะพ ะฒ ะฟะพะปะฝะพะปัะฝะธะต"
"ะญัะพั ัะธััะฐะป ัะฐะฑะพัะฐะตั ั 90% ะผะพะธั ะบะปะธะตะฝัะพะบ"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ซ ะะะะะะฉะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ "ะัะตะปะตะฝะฝะฐั ะฟัะธะณะพัะพะฒะธะปะฐ/ะฟะพัะปะฐะปะฐ/ะฟะพะบะฐะทัะฒะฐะตั" โ ะฐะฑัััะฐะบัะธั
โ "ะญะฝะตัะณะธะธ ะดะฝั/ะผะตัััะฐ" ะฑะตะท ะพะฑัััะฝะตะฝะธั ััะพ ะดะตะปะฐัั
โ "ะัะบัะพะน ะฟะพััะฐะป/ะบะฐะฝะฐะป/ะฟะพัะพะบ" โ ะฟััััะต ัะปะพะฒะฐ
โ ะฃะฟะพะผะธะฝะฐะฝะธะต ะบะพะฝะบัะตัะฝัั ะณะพะดะพะฒ (2025, 2026) โ ะบะพะฝัะตะฝั ัััะฐัะตะตั
โ ะกะบััะฝัะต ะฝะฐัะฐะปะฐ ัะธะฟะฐ "ะกะตะณะพะดะฝั ัะพัั ัะฐััะบะฐะทะฐัั..."

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกะขะะะฌ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะะพัะพัะบะธะต ะฟัะตะดะปะพะถะตะฝะธั. ะะฐะบัะธะผัะผ 12 ัะปะพะฒ.
- ะะธัะธ ะบะฐะบ ะณะพะปะพัะพะฒะพะต ะฟะพะดััะณะต โ ะถะธะฒะพ, ัะผะพัะธะพะฝะฐะปัะฝะพ
- ะญะผะพะดะทะธ ัะผะตััะฝั, ะฝะพ ะฝะต ะฑะพะปััะต 3-4 ะฝะฐ ะฟะพัั
- ะะผะตััะพ ะณะพะดะฐ ะฟะธัะธ: "ะฒ ะฑะปะธะถะฐะนัะธะน ะผะตััั", "ััะพั ะฟะตัะธะพะด", "ัะบะพัะพ"
- ะะฐะถะดัะน ัะตะบัั = ัะผะพัะธั + ะฟะพะปัะทะฐ + ะดะตะนััะฒะธะต

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ะะะะ ะฆะะะะะะ ะะฃะะะขะะะะ (ะฑะตะน ะฒ ะฝะธั!):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะฐะถะดะฐั ัะตะผะฐ ะดะพะปะถะฝะฐ ะบะฐัะฐัััั ะะะะะฌะะะ ะฟัะพะฑะปะตะผั. ะะตะฝะตัะธััะน ะฟะพ ะฐะฝะฐะปะพะณะธะธ, ะบะฐะถะดัะน ัะฐะท ะะะะซะ ัะพัะผัะปะธัะพะฒะบะธ:

๐ ะะขะะะจะะะะฏ (ัะฐะผะฐั ะณะพัััะฐั ัะตะผะฐ!):
- "ะะฝ ะฝะต ะฟะธัะตั/ะฝะต ะทะฒะพะฝะธั โ ััะพ ะดะตะปะฐัั?"
- "ะะพัะตะผั ะฒัะต ะผะพะธ ะพัะฝะพัะตะฝะธั ะทะฐะบะฐะฝัะธะฒะฐัััั ะพะดะธะฝะฐะบะพะฒะพ?"
- "ะะฐะบ ะฟะพะฝััั, ะธะทะผะตะฝัะตั ะปะธ ะพะฝ?"
- "ะะตัะฝัััั ะปะธ ะฑัะฒัะธะน?"
- "ะะพัะตะผั ะฟัะธััะณะธะฒะฐั ัะพะบัะธัะฝัั/ะถะตะฝะฐััั/ะฝะตะดะพัััะฟะฝัั?"
- "ะะฐะบ ะพัะฟัััะธัั ัะพะณะพ, ะบัะพ ะฝะต ะพัะฟััะบะฐะตั?"

๐ฐ ะะะะฌะะ ะ ะะะะะขะ:
- "ะะพัะตะผั ะดะตะฝัะณะธ ะฝะต ะทะฐะดะตัะถะธะฒะฐัััั?"
- "ะะฐะบ ะฒัะนัะธ ะธะท ัะธะฝะฐะฝัะพะฒะพะน ัะผั?"
- "ะกััะฐั ะฑะพะปััะธั ะดะตะฝะตะณ โ ะพัะบัะดะฐ?"
- "ะะพัะตะผั ั ัะฐะฑะพัะฐั ะผะฝะพะณะพ, ะฐ ะทะฐัะฐะฑะฐััะฒะฐั ะผะฐะปะพ?"
- "ะะฐะบ ะฝะฐะนัะธ ัะฒะพั ะดะตะปะพ/ะฟัะธะทะฒะฐะฝะธะต?"
- "ะะพััั ะผะตะฝััั ัะฐะฑะพัั"

๐ ะกะะะะะะะะะะะฆะะฏ:
- "ะะต ะทะฝะฐั, ัะตะณะพ ัะพัั ะพั ะถะธะทะฝะธ"
- "ะะฐััััะปะฐ ะฝะฐ ะพะดะฝะพะผ ะผะตััะต"
- "ะงัะฒััะฒัั, ััะพ ะถะธะฒั ะฝะต ัะฒะพั ะถะธะทะฝั"
- "ะกััะฐั ะฝะฐัะฐัั ััะพ-ัะพ ะฝะพะฒะพะต"
- "ะกะธะฝะดัะพะผ ัะฐะผะพะทะฒะฐะฝัะฐ"

๐จโ๐ฉโ๐ง ะกะะะฌะฏ ะ ะะะขะ:
- "ะกะฒะตะบัะพะฒั/ะผะฐะผะฐ ะปะตะทะตั ะฒ ะผะพั ะถะธะทะฝั"
- "ะัะถ ะฝะต ะฟะพะฝะธะผะฐะตั/ะฝะต ัะปััะธั"
- "ะัะพะฑะปะตะผั ั ัะตะฑัะฝะบะพะผ-ะฟะพะดัะพััะบะพะผ"
- "ะะพัะตะผั ะฒ ะผะพัะผ ัะพะดั ะฒัะต ัะฐะทะฒะพะดัััั?"

โก ะญะะะะะะฏ ะ ะะะะะะะฌะ:
- "ะะพััะพัะฝะฝะฐั ัััะฐะปะพััั, ะฝะตั ัะธะป"
- "ะงัะฒััะฒัั, ััะพ ะฝะฐ ะผะฝะต ะฟะพััะฐ/ัะณะปะฐะท"
- "ะะฐะฝะธัะตัะบะธะต ะฐัะฐะบะธ, ััะตะฒะพะณะฐ"
- "ะะตััะพะฝะฝะธัะฐ, ะฟะปะพัะธะต ัะฝั"

โ๏ธ ะะะะะ: 
- ะะฐะถะดัะน ัะฐะท ะณะตะฝะตัะธััะน ะะะะซะ ัะตะผั ะฟะพ ะฐะฝะฐะปะพะณะธะธ ั ะฟัะธะผะตัะฐะผะธ
- ะงะตัะตะดัะน ะบะฐัะตะณะพัะธะธ ะฑะพะปะตะน (ะฝะต 5 ะฟะพััะพะฒ ะฟะพะดััะด ะฟัะพ ะพัะฝะพัะตะฝะธั)
- ะคะพัะผัะปะธััะน ััะบะธ ัะตัะตะท ะฑะพะปั: "ะฃััะฐะปะฐ ะพั..." / "ะะพัะตะผั ะพะฟััั..." / "ะะฐะบ ะธะทะฑะฐะฒะธัััั ะพั..."
- ะะ ะะะะขะะะฏะ ะพะดะฝะธ ะธ ัะต ะถะต ัะตะผั โ ะฟัะธะดัะผัะฒะฐะน ะฒะฐัะธะฐัะธะธ`;

  // Different system prompts for sale vs engagement
  const saleSystemPrompt = `ะขั โ SMM-ะบะพะฟะธัะฐะนัะตั ะดะปั ัะทะพัะตัะธัะตัะบะธั ะฟัะฐะบัะธะบะพะฒ. ะขะฒะพั ััะฟะตััะธะปะฐ โ ะฟะธัะฐัั ัะตะบััั, ะบะพัะพััะต ะะะะะะฎะข ัะตัะตะท ะฒะพะฒะปะตัะตะฝะธะต, ะฐ ะฝะต ัะตัะตะท ะดะฐะฒะปะตะฝะธะต.
${writingStyleRules}

ะขะะะฏ ะะะะะงะ: ะกะพะทะดะฐัั ะฟัะพะดะฐััะธะน ะบะพะฝัะตะฝั-ะฟะปะฐะฝ, ะณะดะต ะบะฐะถะดัะน ะฟะพัั ัะฝะฐัะฐะปะฐ ะฆะะะะฏะะข, ะฟะพัะพะผ ะฟัะพะดะฐัั.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ะกะขะะะขะะะะฏ ะะฏะะะะฅ ะะะะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
1. ะะะะะะงะฌ (ััะบ, ะธะฝััะธะณะฐ, ัะทะฝะฐะฒะฐะฝะธะต ัะตะฑั)
2. ะะะขะฌ ะะะะฌะะฃ (ะฟะพะบะฐะทะฐัั ัะบัะฟะตััะฝะพััั)
3. ะะฏะะะ ะะะะะะขะฌ (ัะตัะตะท ะธััะพัะธั ะธะปะธ ะบะตะนั)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ะะะะะะฎะฉะะ ะขะะฅะะะะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- "ะัะปะพ โ ะกัะฐะปะพ": ะธััะพัะธั ะบะปะธะตะฝัะบะธ ั ัะตะทัะปััะฐัะพะผ
- FOMO: "ะััะฐะปะพัั 3 ะผะตััะฐ ะฝะฐ ััะพะน ะฝะตะดะตะปะต"
- ะกะพัะธะฐะปัะฝะพะต ะดะพะบะฐะทะฐัะตะปัััะฒะพ: "ะฃะถะต 200+ ะดะตะฒััะตะบ ะฟัะพัะปะธ"
- ะกะตะบัะตัะฝะพััั: "ะะฐััะบะฐะทัะฒะฐั ัะพะปัะบะพ ะฒ ะปะธัะฝะพะน ัะฐะฑะพัะต, ะฝะพ..."
- ะะณัะฐะฝะธัะตะฝะธะต: "ะะตัั ัะพะปัะบะพ 5 ะบะปะธะตะฝัะพะฒ ะฒ ะผะตััั"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะะะก ะะะะขะะะขะ (ัะพะฑะปัะดะฐะน!):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- 30% ะััะผัะต ะฟัะพะดะฐะถะธ: ะบะตะนัั, ะพัะทัะฒั, "ะทะฐะฟะธัั ะพัะบัััะฐ"
- 30% ะญะบัะฟะตััะฝัะน: ะฟะพะปัะทะฐ + ะผัะณะบะพะต ัะฟะพะผะธะฝะฐะฝะธะต ััะปัะณะธ
- 25% ะะพะฒะปะตะบะฐััะธะน: ัะตััั, ะพะฟัะพัั (ัะฐะทะพะณัะตะฒ ะฐัะดะธัะพัะธะธ)
- 15% ะะธัะฝัะต ะธััะพัะธะธ: ะฟััั, ะธะฝัะฐะนัั, ะทะฐะบัะปะธััะต

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โก ะ ะะะะะะ ะะะกะขะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะฅัะบ ะฒ ะฟะตัะฒะพะน ัััะพะบะต (ะธัะฟะพะปัะทัะน ัะพัะผัะปั ะฒััะต!)
- ะัะธะทัะฒ ะบ ะดะตะนััะฒะธั: ะบะพะฝะบัะตัะฝัะน ะธ ะฟัะพััะพะน
- ะฃะฟะพะผะธะฝะฐะฝะธะต ะฟัะพะดัะบัะฐ โ ะตััะตััะฒะตะฝะฝะพ, ัะตัะตะท ะฟะพะปัะทั

ะะะฏ ะะะะะะะ ะะะฏ ัะพะทะดะฐะน:
- idea: ะธะดะตั ั ััะบะพะผ (ัะตะฟะปัััะฐั ัะพัะผัะปะธัะพะฒะบะฐ!)
- type: ัะธะฟ (ะัะพะดะฐััะธะน/ะญะบัะฟะตััะฝัะน/ะะธัะฝะฐั ะธััะพัะธั/ะะพะฒะปะตะบะฐััะธะน)
- post: ะฟะพัั ะดะปั ะปะตะฝัั (ััะบ โ ะฟะพะปัะทะฐ โ ะฟัะธะทัะฒ ะบ ะฟะพะบัะฟะบะต)
- carousel: 5-7 ัะปะฐะนะดะพะฒ. ะะตัะฒัะน = ะธะฝััะธะณะฐ. ะะพัะปะตะดะฝะธะน = ะฟัะธะทัะฒ. ะคะพัะผะฐั "ะกะปะฐะนะด 1: ..."
- reels: ััะตะฝะฐัะธะน (ัะพะบ-ััะบ โ ะฟะพะปัะทะฐ โ ะฟัะธะทัะฒ ะทะฐะฟะธัะฐัััั)
- stories: 4-5 ััะพัะธั ั ะฒะพัะพะฝะบะพะน (ะธะฝัะตัะตั โ ะฟะพะปัะทะฐ โ ะพััะตั)

ะคะพัะผะฐั: ะขะะะฌะะ JSON ะผะฐััะธะฒ.
ะัะธะผะตั: [{"day":1,"idea":"ะะพัะตะผั ะพะฝ ะฝะต ะฟะธัะตั? ะะฐััั ะฟะพะบะฐะทะฐะปะธ ะฟัะธัะธะฝั, ะบะพัะพััั ะพะฝะฐ ะฝะต ะพะถะธะดะฐะปะฐ","type":"ะัะพะดะฐััะธะน","post":{"content":"ะะฝะฐ ะฟัะธัะปะฐ ั ะฒะพะฟัะพัะพะผ: 'ะะพัะตะผั ะพะฝ ะทะฐะผะพะปัะฐะป?'\\n\\nะัะผะฐะปะฐ โ ัะฐะทะปัะฑะธะป. ะะฐััั ะฟะพะบะฐะทะฐะปะธ ะดััะณะพะต: ะพะฝ ะฑะพะธััั ัะตัััะทะฝัั ะพัะฝะพัะตะฝะธะน.\\n\\nะงะตัะตะท ะฝะตะดะตะปั ะพะฝ ะฒะตัะฝัะปัั. ะกะฐะผ. ะะพัะพะผั ััะพ ะพะฝะฐ ะฟะตัะตััะฐะปะฐ ะดะฐะฒะธัั.\\n\\nโ ะฅะพัะตัั ะฟะพะฝััั, ััะพ ะฟัะพะธััะพะดะธั ะฒ ัะฒะพะธั ะพัะฝะพัะตะฝะธัั? ะกััะปะบะฐ ะฒ ัะฐะฟะบะต","hashtags":["#ัะฐัะพ","#ะพัะฝะพัะตะฝะธั"]},"carousel":{"content":"ะกะปะฐะนะด 1: ะะฝ ะทะฐะผะพะปัะฐะป. ะงัะพ ะดะตะปะฐัั?\\n(ะััะพัะธั ะบะปะธะตะฝัะบะธ)\\n\\nะกะปะฐะนะด 2: ะะฝะฐ ะฝะฐะฟะธัะฐะปะฐ ะผะฝะต ะฒ ะฟะฐะฝะธะบะต...\\n\\nะกะปะฐะนะด 7: ะฅะพัะตัั ัะฐะทะพะฑัะฐัััั ะฒ ัะฒะพะตะน ัะธััะฐัะธะธ?\\nะะฐะฟะธัั ะฒ ะดะธัะตะบั ๐","hashtags":["#ัะฐัะพ","#ะพัะฝะพัะตะฝะธั"]},"reels":{"content":"ะฅัะบ (0-3 ัะตะบ): ะะฝ ะฝะต ะฟะธัะตั? ะะพั ะฟะพัะตะผั.\\n\\nะัะฝะพะฒะฐ: 3 ะฟัะธัะธะฝั ะผัะถัะบะพะณะพ ะผะพะปัะฐะฝะธั...\\n\\nะัะธะทัะฒ: ะะฐะฟะธัะธ 'ัะพัั ัะฐัะบะปะฐะด' โ ัะฐะทะฑะตััะผ ัะฒะพั ัะธััะฐัะธั","hashtags":["#ัะฐัะพ"]},"stories":{"content":"ะกัะพัะธั 1: ะะฟัะพั: ะะฝ ะทะฐะผะพะปะบะฐะป ะฑะตะท ะฟัะธัะธะฝั? ะะฐ/ะะตั/ะะพััะพัะฝะฝะพ\\n\\nะกัะพัะธั 2: ะะฐััะบะฐะถั ะธััะพัะธั ะบะปะธะตะฝัะบะธ...\\n\\nะกัะพัะธั 3: ะะฐััั ะฟะพะบะฐะทะฐะปะธ ัะพ, ััะพ ะพะฝะฐ ะฝะต ะพะถะธะดะฐะปะฐ\\n\\nะกัะพัะธั 4: ะงะตัะตะท ะฝะตะดะตะปั ะพะฝ ะฒะตัะฝัะปัั ะกะะ\\n\\nะกัะพัะธั 5: ะฅะพัะตัั ะฟะพะฝััั ัะฒะพั ัะธััะฐัะธั? ะะธัะธ 'ัะพัั'","hashtags":["#ัะฐัะพ"]}}]${archetypeInstruction}`;

  const engagementSystemPrompt = `ะขั โ SMM-ะบะพะฟะธัะฐะนัะตั ะดะปั ัะทะพัะตัะธัะตัะบะธั ะฟัะฐะบัะธะบะพะฒ. ะขะฒะพั ััะฟะตััะธะปะฐ โ ัะพะทะดะฐะฒะฐัั ะะะะฃะกะะซะ ะบะพะฝัะตะฝั, ะบะพัะพััะน ะฒะทััะฒะฐะตั ะพัะฒะฐัั.
${writingStyleRules}

ะขะะะฏ ะะะะะงะ: ะกะพะทะดะฐัั ะบะพะฝัะตะฝั-ะฟะปะฐะฝ, ะบะพัะพััะน ะะะะะะะข ะพัะฒะฐัั. ะะฐะถะดัะน ะฟะพัั = ะฟะพัะตะฝัะธะฐะปัะฝัะน ะฒะธััั.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฏ ะฆะะะ ะะะะะะะ ะะะกะขะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
1. ะะกะขะะะะะะขะฌ ัะบัะพะปะป (ัะพะบ-ััะบ ะฒ ะฟะตัะฒะพะน ัััะพะบะต)
2. ะฃะะะะะะขะฌ ะดะพ ะบะพะฝัะฐ (ะธะฝััะธะณะฐ, ะพัะบัััะฐั ะฟะตัะปั)
3. ะะซะะะะขะฌ ะดะตะนััะฒะธะต (ะบะพะผะผะตะฝั/ัะพััะฐะฝะตะฝะธะต/ัะตะฟะพัั)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะะะก ะะะะขะะะขะ (ัะพะฑะปัะดะฐะน ะฑะฐะปะฐะฝั!):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- 40% ะะพะฒะปะตะบะฐััะธะน: ัะตััั, ะพะฟัะพัั, ัะณะฐะดะฐะนะบะธ, "ะฝะฐะฟะธัะธ ัะฒะพะน ะทะฝะฐะบ"
- 30% ะญะบัะฟะตััะฝัะน: ะปะฐะนััะฐะบะธ, ัะตะบะปะธััั, "ัะพััะฐะฝะธ ัะตะฑะต"
- 20% ะะธัะฝัะต ะธััะพัะธะธ: ั ะฝะตะพะถะธะดะฐะฝะฝัะผ ะฟะพะฒะพัะพัะพะผ
- 10% ะะฐะทะฒะปะตะบะฐัะตะปัะฝัะน: ะผะตะผั ะฟัะพ ะทะฝะฐะบะธ, ัะผะตัะฝัะต ะฝะฐะฑะปัะดะตะฝะธั

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โก ะะะฏะะะขะะะฌะะ ะ ะะะะะะ ะะะกะขะ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะฅัะบ ะฒ ะฟะตัะฒะพะน ัััะพะบะต (ัะผ. ัะพัะผัะปั ะฒััะต)
- ะัะธะทัะฒ ะบ ะดะตะนััะฒะธั ะฒ ะบะพะฝัะต
- ะะปั ะบะฐัััะตะปะธ: ะธะฝััะธะณะฐ ะฝะฐ ะฟะตัะฒะพะผ ัะปะฐะนะดะต ("ะะธััะฐะน ะดะพ ะบะพะฝัะฐ!")
- ะะปั ัะธะปั: ัะพะบ ะฒ ะฟะตัะฒัะต 3 ัะตะบัะฝะดั

ะะะฏ ะะะะะะะ ะะะฏ ัะพะทะดะฐะน:
- idea: ะธะดะตั ั ััะบะพะผ (ะฝะต ะฟัะพััะพ ัะตะผะฐ, ะฐ ัะตะฟะปัััะฐั ัะพัะผัะปะธัะพะฒะบะฐ!)
- type: ัะธะฟ (ะะพะฒะปะตะบะฐััะธะน/ะญะบัะฟะตััะฝัะน/ะะธัะฝะฐั ะธััะพัะธั/ะะฐะทะฒะปะตะบะฐัะตะปัะฝัะน)
- post: ะฟะพัั ะดะปั ะปะตะฝัั (ััะบ โ ัะฐัะบัััะธะต โ ะฟัะธะทัะฒ)
- carousel: ะบะฐัััะตะปั 5-7 ัะปะฐะนะดะพะฒ. ะะะะะซะ ัะปะฐะนะด = ะธะฝััะธะณะฐ. ะคะพัะผะฐั "ะกะปะฐะนะด 1: ะะฐะณะพะปะพะฒะพะบ\\nะขะตะบัั..."
- reels: ััะตะฝะฐัะธะน (0-3 ัะตะบ: ัะพะบ-ััะบ โ 3-20 ัะตะบ: ะฟะพะปัะทะฐ โ ะฟัะธะทัะฒ)
- stories: ัะตัะธั 4-5 ััะพัะธั ั ะพะฟัะพัะฐะผะธ/ะฒัะฑะพัะพะผ. ะคะพัะผะฐั "ะกัะพัะธั 1: ..."

ะคะพัะผะฐั: ะขะะะฌะะ JSON ะผะฐััะธะฒ.
ะัะธะผะตั: [{"day":1,"idea":"ะฃััะฐะปะฐ ะพั ะพัะฝะพัะตะฝะธะน, ะณะดะต ัั ะดะฐััั ะฑะพะปััะต, ัะตะผ ะฟะพะปััะฐะตัั? ะะพั ะฟะพัะตะผั ััะพ ะฟัะพะธััะพะดะธั","type":"ะะพะฒะปะตะบะฐััะธะน","post":{"content":"ะขั ะพัะดะฐััั. ะะฝ ะฟัะธะฝะธะผะฐะตั.\\n\\nะขั ััะฐัะฐะตัััั. ะะฝ โ ะฝะตั.\\n\\nะะฝะฐะบะพะผะพ? ะญัะพ ะฝะต ะพะฝ ะฟะปะพัะพะน. ะญัะพ ะฟะฐััะตัะฝ.\\n\\nะะฐะฟะธัะธ ัะฒะพะน ะทะฝะฐะบ โ ัะฐััะบะฐะถั, ะฟะพัะตะผั ัั ะฟัะธััะณะธะฒะฐะตัั ัะฐะบะธั ะผัะถัะธะฝ ๐","hashtags":["#ะฐัััะพะปะพะณะธั","#ะพัะฝะพัะตะฝะธั"]},"carousel":{"content":"ะกะปะฐะนะด 1: ะะพัะตะผั ัั ะฟัะธััะณะธะฒะฐะตัั ัะตั, ะบัะพ ะฝะต ัะตะฝะธั?\\n(ะะฐะทะฑะพั ะฟะพ ะทะฝะฐะบะฐะผ)\\n\\nะกะปะฐะนะด 2: โ ะะฒะตะฝ\\nะขั ัะธะปัะฝะฐั. ะัะธััะณะธะฒะฐะตัั ัะปะฐะฑัั, ะบะพัะพััะต ัะฐะดัััั ะฝะฐ ัะตั.\\n\\nะกะปะฐะนะด 3: โ ะขะตะปะตั\\nะขั ัะตัะฟะตะปะธะฒะฐั. ะกะปะธัะบะพะผ. ะัะถัะธะฝั ััะธะผ ะฟะพะปัะทััััั.","hashtags":["#ะฐัััะพะปะพะณะธั"]},"reels":{"content":"ะฅัะบ (0-3 ัะตะบ): ะฃััะฐะปะฐ ะฑััั ัะดะพะฑะฝะพะน?\\n\\nะัะฝะพะฒะฐ (3-20 ัะตะบ): 3 ะฟัะธัะธะฝั, ะฟะพัะตะผั ัะฒะพะน ะทะฝะฐะบ ะฟัะธััะณะธะฒะฐะตั ัะตั, ะบัะพ ะฝะต ัะตะฝะธั...\\n\\nะัะธะทัะฒ: ะะฐะฟะธัะธ ัะฒะพะน ะทะฝะฐะบ โ ัะฐััะบะฐะถั ัะฒะพั ะฟัะธัะธะฝั!","hashtags":["#ะฐัััะพะปะพะณะธั"]},"stories":{"content":"ะกัะพัะธั 1: ะะฟัะพั: ะงัะฒััะฒัะตัั, ััะพ ะดะฐััั ะฑะพะปััะต, ัะตะผ ะฟะพะปััะฐะตัั? ะะฐ/ะะฝะพะณะดะฐ/ะะตั\\n\\nะกัะพัะธั 2: ะญัะพ ะฝะต ัะปััะฐะนะฝะพััั. ะญัะพ ะฟะฐััะตัะฝ.\\n\\nะกัะพัะธั 3: ะ ะพะฝ ัะฒัะทะฐะฝ ั ัะฒะพะธะผ ะทะฝะฐะบะพะผ!\\n\\nะกัะพัะธั 4: ะะฐะฟะธัะธ ัะฒะพะน ะทะฝะฐะบ โ ัะฐััะบะฐะถั, ะบะฐะบ ััะพ ะธะทะผะตะฝะธัั","hashtags":["#ะฐัััะพะปะพะณะธั"]}}]${archetypeInstruction}`;

  const systemPrompt = goal === "sale" ? saleSystemPrompt : engagementSystemPrompt;

  const userPrompt = goal === "sale" 
    ? `ะกะพะทะดะฐะน ะะะะะะฎะฉะะ ะบะพะฝัะตะฝั-ะฟะปะฐะฝ ะฝะฐ ${days} ${getDaysWord(days)} ะดะปั:

ะะะจะ: ${niche}

ะะะะะฃะะข ะะะฏ ะะะะะะะ: "${product || 'ะบะพะฝััะปััะฐัะธั'}"

ะกะขะะะขะะะะฏ: ${strategyDescription}

ะะะฏะะะขะะะฌะะซะ ะขะะะะะะะะะฏ:
1. ะกะพะทะดะฐะน ัะพะฒะฝะพ ${days} ะดะฝะตะน ะบะพะฝัะตะฝัะฐ
2. ะะฐ ะะะะะซะ ะดะตะฝั ัะพะทะดะฐะน:
   - idea: ะบัะฐัะบะฐั ะธะดะตั ะดะฝั
   - type: ัะธะฟ (ะญะบัะฟะตััะฝัะน/ะะธัะฝะฐั ะธััะพัะธั/ะัะพะดะฐััะธะน/ะะพะฒะปะตะบะฐััะธะน)
   - post: ะณะพัะพะฒัะน ัะตะบัั ะดะปั ะปะตะฝัั (2-3 ะฐะฑะทะฐัะฐ + ะฟัะธะทัะฒ)
   - carousel: ัะตะบัั ะดะปั ะบะฐัััะตะปะธ (5-7 ัะปะฐะนะดะพะฒ, ัะพัะผะฐั "ะกะปะฐะนะด 1: ...")
   - reels: ััะตะฝะฐัะธะน ัะธะปั (ััะบ โ ะพัะฝะพะฒะฐ โ ะฟัะธะทัะฒ)
   - stories: ัะตัะธั ััะพัะธั (4-5 ัะปะฐะนะดะพะฒ, ัะพัะผะฐั "ะกัะพัะธั 1: ...")
3. ะะฐะถะดัะน ัะพัะผะฐั ั hashtags ะผะฐััะธะฒะพะผ

ะัะฒะตัั ะขะะะฌะะ JSON ะผะฐััะธะฒะพะผ.`
    : `ะกะพะทะดะฐะน ะบะพะฝัะตะฝั-ะฟะปะฐะฝ ะฝะฐ ${days} ${getDaysWord(days)} ะดะปั ะะะะะะงะะะะฏ:

ะะะจะ: ${niche}

ะฆะะะฌ: ะฃะฒะตะปะธัะธัั ะพัะฒะฐัั, ะปะฐะนะบะธ, ะบะพะผะผะตะฝัะฐัะธะธ, ัะพััะฐะฝะตะฝะธั

ะะะฏะะะขะะะฌะะซะ ะขะะะะะะะะะฏ:
1. ะกะพะทะดะฐะน ัะพะฒะฝะพ ${days} ะดะฝะตะน ะบะพะฝัะตะฝัะฐ
2. ะะฐ ะะะะะซะ ะดะตะฝั ัะพะทะดะฐะน:
   - idea: ะบัะฐัะบะฐั ะธะดะตั ะดะฝั
   - type: ัะธะฟ (ะญะบัะฟะตััะฝัะน/ะะธัะฝะฐั ะธััะพัะธั/ะะพะฒะปะตะบะฐััะธะน/ะะฐะทะฒะปะตะบะฐัะตะปัะฝัะน)
   - post: ะณะพัะพะฒัะน ัะตะบัั ะดะปั ะปะตะฝัั (2-3 ะฐะฑะทะฐัะฐ + ะฟัะธะทัะฒ)
   - carousel: ัะตะบัั ะดะปั ะบะฐัััะตะปะธ (5-7 ัะปะฐะนะดะพะฒ, ัะพัะผะฐั "ะกะปะฐะนะด 1: ...")
   - reels: ััะตะฝะฐัะธะน ัะธะปั (ััะบ โ ะพัะฝะพะฒะฐ โ ะฟัะธะทัะฒ)
   - stories: ัะตัะธั ััะพัะธั (4-5 ัะปะฐะนะดะพะฒ, ัะพัะผะฐั "ะกัะพัะธั 1: ...")
3. ะะฐะถะดัะน ัะพัะผะฐั ั hashtags ะผะฐััะธะฒะพะผ

ะัะฒะตัั ะขะะะฌะะ JSON ะผะฐััะธะฒะพะผ.`;

  try {
    console.log("Calling DeepSeek API...");
    const startTime = Date.now();
    
    const response = await getClient().chat.completions.create({
      model: "deepseek-chat",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.7,
      max_tokens: 8000,
    });

    const elapsed = Date.now() - startTime;
    console.log(`DeepSeek API responded in ${elapsed}ms`);

    const content = response.choices[0]?.message?.content || "[]";
    console.log("Raw AI response length:", content.length);
    
    if (content.length < 100) {
      console.error("Response too short, content:", content);
      throw new Error("AI returned empty or too short response");
    }
    
    return parseContentResponse(content);
  } catch (error: any) {
    console.error("Content generation error:", error?.message || error);
    console.error("Error details:", JSON.stringify(error, null, 2));
    throw error;
  }
}

function getDaysWord(days: number): string {
  if (days === 1) return "ะดะตะฝั";
  if (days >= 2 && days <= 4) return "ะดะฝั";
  return "ะดะฝะตะน";
}

// New interfaces for two-step generation
export interface ContentIdea {
  day: number;
  idea: string;
  type: string;
}

export interface SingleFormatInput {
  goal: "sale" | "engagement";
  niche: string;
  product?: string;
  idea: string;
  type: string;
  format: "post" | "carousel" | "reels" | "stories";
  archetype?: {
    name: string;
    description: string;
    recommendations: string[];
    triggerWords?: string[];
    contentStyle?: string[];
    tone?: string;
  };
}

// Step 1: Generate only ideas (fast, ~10-20 seconds)
export async function generateIdeasOnly(input: ContentGenerationInput): Promise<ContentIdea[]> {
  const { goal, niche, days, product, strategy, archetype } = input;
  
  const archetypeInstruction = archetype 
    ? `\n\nะััะตัะธะฟ ะฑัะตะฝะดะฐ: ${archetype.name}. ${archetype.description}`
    : "";

  const systemPrompt = `ะขั โ ัััะฐัะตะณ ะบะพะฝัะตะฝัะฐ ะดะปั ัะทะพัะตัะธัะตัะบะธั ะฟัะฐะบัะธะบะพะฒ.
ะขะฒะพั ะทะฐะดะฐัะฐ: ะฟัะธะดัะผะฐัั ัะตะฟะปัััะธะต ะธะดะตะธ ะดะปั ะฟะพััะพะฒ.

ะะะะะะะ ะะะฏ ะะะะ:
- ะะดะตั ะดะพะปะถะฝะฐ ะฒัะทัะฒะฐัั ะปัะฑะพะฟััััะฒะพ
- ะคะพัะผัะปะธััะน ะบะฐะบ ะทะฐะณะพะปะพะฒะพะบ, ะบะพัะพััะน ัะพัะตััั ะบะปะธะบะฝััั
- ะะทะฑะตะณะฐะน ะฑะฐะฝะฐะปััะธะฝั ัะธะฟะฐ "ะกะธะปะฐ ะัะฝั" ะธะปะธ "ะะฐะณะธั ะขะฐัะพ"
- ะัะฟะพะปัะทัะน ะฑะพะปะธ ะธ ะถะตะปะฐะฝะธั ะฐัะดะธัะพัะธะธ${archetypeInstruction}`;

  const userPrompt = goal === "sale"
    ? `ะัะธะดัะผะฐะน ${days} ัะตะฟะปัััะธั ะธะดะตะน ะดะปั ะะะะะะฎะฉะะะ ะบะพะฝัะตะฝัะฐ:
ะะะจะ: ${niche}
ะะะะะฃะะข: "${product || 'ะบะพะฝััะปััะฐัะธั'}"

ะัะธะผะตัั ะฅะะะะจะะฅ ะธะดะตะน:
- "ะะพัะตะผั ัะฒะพะธ ัะฐัะบะปะฐะดั ะฝะต ัะฑัะฒะฐัััั (ะธ ััะพ ั ััะธะผ ะดะตะปะฐัั)"
- "3 ะทะฝะฐะบะฐ, ััะพ ะฟะพัะฐ ะผะตะฝััั ะฟะพะดัะพะด ะบ ะฟัะฐะบัะธะบะต"
- "ะะปะธะตะฝัะบะฐ ะทะฐะฟะปะฐัะธะปะฐ 50ะบ ะธ ะฟัะพะฟะฐะปะฐ. ะงัะพ ัะปััะธะปะพัั ะดะฐะปััะต"

ะะปั ะบะฐะถะดะพะณะพ ะดะฝั:
- day: ะฝะพะผะตั
- idea: ัะตะฟะปัััะฐั ัะพัะผัะปะธัะพะฒะบะฐ (1-2 ะฟัะตะดะปะพะถะตะฝะธั)
- type: ัะธะฟ (ะญะบัะฟะตััะฝัะน/ะะธัะฝะฐั ะธััะพัะธั/ะัะพะดะฐััะธะน/ะะพะฒะปะตะบะฐััะธะน)

JSON ะผะฐััะธะฒ: [{"day":1,"idea":"...","type":"..."}]`
    : `ะัะธะดัะผะฐะน ${days} ัะตะฟะปัััะธั ะธะดะตะน ะดะปั ะะะะะะะะฎะฉะะะ ะบะพะฝัะตะฝัะฐ:
ะะะจะ: ${niche}

ะัะธะผะตัั ะฅะะะะจะะฅ ะธะดะตะน:
- "ะะฐะบะพะน ัั ะฐััะตัะธะฟ ะฒ ะพัะฝะพัะตะฝะธัั? ะขะตัั"
- "5 ะฒะตัะตะน, ะบะพัะพััะต ะดะตะปะฐัั ะฒัะต ะฝะฐัะธะฝะฐััะธะต ัะฐัะพะปะพะณะธ"
- "ะฃะณะฐะดะฐะน ะทะฝะฐะบ ะทะพะดะธะฐะบะฐ ะฟะพ ะฟัะธะฒััะบะต"

ะะปั ะบะฐะถะดะพะณะพ ะดะฝั:
- day: ะฝะพะผะตั
- idea: ัะตะฟะปัััะฐั ัะพัะผัะปะธัะพะฒะบะฐ (1-2 ะฟัะตะดะปะพะถะตะฝะธั)
- type: ัะธะฟ (ะญะบัะฟะตััะฝัะน/ะะธัะฝะฐั ะธััะพัะธั/ะะพะฒะปะตะบะฐััะธะน/ะะฐะทะฒะปะตะบะฐัะตะปัะฝัะน)

JSON ะผะฐััะธะฒ: [{"day":1,"idea":"...","type":"..."}]`;

  try {
    console.log("Generating ideas only...");
    const startTime = Date.now();
    
    const response = await getClient().chat.completions.create({
      model: "deepseek-chat",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.7,
      max_tokens: 1500,
    });

    const elapsed = Date.now() - startTime;
    console.log(`Ideas generated in ${elapsed}ms`);

    const content = response.choices[0]?.message?.content || "[]";
    const cleaned = cleanJsonResponse(content);
    const jsonMatch = cleaned.match(/\[[\s\S]*\]/);
    
    if (!jsonMatch) {
      throw new Error("Invalid response format");
    }
    
    return JSON.parse(jsonMatch[0]) as ContentIdea[];
  } catch (error: any) {
    console.error("Ideas generation error:", error?.message || error);
    throw error;
  }
}

// Step 2: Generate single format content (on demand)
export async function generateSingleFormat(input: SingleFormatInput): Promise<FormatContent> {
  const { goal, niche, product, idea, type, format, archetype } = input;
  
  const archetypeInstruction = archetype 
    ? `\n\nะะะฅะะขะะ ะะะะะะ: "${archetype.name}"
${archetype.description}
${archetype.tone ? `ะขะพะฝะฐะปัะฝะพััั: ${archetype.tone}` : ''}
${archetype.triggerWords?.length ? `ะกะปะพะฒะฐ-ััะธะณะณะตัั (ะธัะฟะพะปัะทัะน ะฒ ัะตะบััะต): ${archetype.triggerWords.slice(0, 8).join(", ")}` : ''}
${archetype.contentStyle?.length ? `ะกัะธะปั: ${archetype.contentStyle.slice(0, 3).join("; ")}` : ''}
ะะปััะตะฒัะต ัะปะพะฒะฐ: ${archetype.recommendations.join(", ")}

ะะธัะธ ะฒ ััะธะปะต ััะพะณะพ ะฐััะตัะธะฟะฐ!`
    : "";

  const writingRules = `
ะะะะะะะ: ะะปะธะตะฝั ัะธัะฐะตั ะฟะตัะฒะพะต ะฟัะตะดะปะพะถะตะฝะธะต โ ะธ ะกะะะะฃ ะฟะพะฝะธะผะฐะตั, ะพ ััะผ ัะตัั.

ะงะะะะะกะข:
โ ะะฐัะฝะธ ั ะะะะะะะขะะะ ะฑะพะปะธ ("ะฃััะฐะปะฐ ะพั ัะฐัะบะปะฐะดะพะฒ, ะบะพัะพััะต ะฝะต ัะฑัะฒะฐัััั?")
โ ะะฐะน ะะะะะะะขะะซะ ัะตะทัะปััะฐั ั ัะธััะพะน ("ะะฐ 60 ะผะธะฝัั ัะฐะทะฑะตััะผ ัะธััะฐัะธั")
โ ะขะตัะผะธะฝ? ะะฑัััะฝะธ ััั ะถะต ะฟัะพัััะผะธ ัะปะพะฒะฐะผะธ
โ ะัะธะทัะฒ โ ััะพ ะะะะะะ ัะดะตะปะฐัั

ะะะะะะฉะะะ:
โ "ะัะตะปะตะฝะฝะฐั ะฟัะธะณะพัะพะฒะธะปะฐ/ะฟะพัะปะฐะปะฐ" โ ะฐะฑัััะฐะบัะธั
โ "ะญะฝะตัะณะธะธ ะณะพะดะฐ" ะฑะตะท ะบะพะฝะบัะตัะธะบะธ ััะพ ะดะตะปะฐัั
โ "ะัะบัะพะน ะฟะพััะฐะป/ะฟะพัะพะบ" โ ะฟััััะต ัะปะพะฒะฐ
โ ะะพัะผะธัะตัะบะธะต ะผะตัะฐัะพัั ะฑะตะท ะฟัะธะฒัะทะบะธ ะบ ะถะธะทะฝะธ

ะะะะกะขะ ะฐะฑัััะฐะบัะธะน โ ะบะพะฝะบัะตัะธะบะฐ:
- ะะ "ะัะตะปะตะฝะฝะฐั ะฟัะธะณะพัะพะฒะธะปะฐ ััะพะบะธ" โ ะ "ะ ัะฝะฒะฐัะต 2 ัะปะพะถะฝัะต ะฝะตะดะตะปะธ. ะะพะบะฐะถั ะบะพะณะดะฐ ะธ ััะพ ะดะตะปะฐัั"
- ะะ "ะะฐััะฐ ะผะตััะฝะพััะธ ะณะพะดะฐ" โ ะ "ะะฐะทะฑะตััะผ ะฟะพ ะผะตัััะฐะผ: ะบะพะณะดะฐ ะผะตะฝััั ัะฐะฑะพัั, ะบะพะณะดะฐ ะพัะปะพะถะธัั ะฟะพะบัะฟะบะธ"

ะกะขะะะฌ: ะะพัะพัะบะธะต ะฟัะตะดะปะพะถะตะฝะธั. ะะฐะบัะธะผัะผ 15 ัะปะพะฒ. ะะฐะบ ะฟะพะดััะณะต ะทะฐ ัะฐะตะผ.`;

  const formatInstructions: Record<string, string> = {
    post: `ะะฐะฟะธัะธ ะะะกะข ะดะปั Instagram (2-3 ะบะพัะพัะบะธั ะฐะฑะทะฐัะฐ).
${writingRules}

ะกัััะบัััะฐ:
1. ะฅัะบ โ ะทะฐัะตะฟะธ ั ะฟะตัะฒะพะณะพ ะฟัะตะดะปะพะถะตะฝะธั (ะฒะพะฟัะพั, ะฟัะพะฒะพะบะฐัะธั, ะธััะพัะธั)
2. ะะฐะทะฒะธัะธะต โ ัะฐัะบัะพะน ัะตะผั ะถะธะฒัะผ ัะทัะบะพะผ
3. ะัะธะทัะฒ โ ััะพ ัะดะตะปะฐัั (ะบะพะฝะบัะตัะฝะพ)`,

    carousel: `ะะฐะฟะธัะธ ะะะะฃะกะะะฌ ะธะท 5-7 ัะปะฐะนะดะพะฒ.
${writingRules}

ะคะะะะะข ะะะฏะะะขะะะะ:
ะะตัะฒัะน ัะปะฐะนะด โ ะบััะฟะฝัะน ะทะฐะณะพะปะพะฒะพะบ (ััะบ, ะทะฐัะตะฟะธัั ะปะธััะฐัั)
ะะฐัะตะผ ะบะฐะถะดัะน ะฝะพะฒัะน ัะปะฐะนะด ะพัะดะตะปัะน ัะธะผะฒะพะปะฐะผะธ ---
ะะพัะปะตะดะฝะธะน ัะปะฐะนะด โ ะฟัะธะทัะฒ ะบ ะดะตะนััะฒะธั

ะะะะะะ:
ะะพัะตะผั ัะฒะพะธ ัะฐัะบะปะฐะดั ะฝะต ัะฐะฑะพัะฐัั

---

ะัะธัะธะฝะฐ 1: ะขั ัะฟัะฐัะธะฒะฐะตัั ะฝะต ัะพ
ะะฐััั ะพัะฒะตัะฐัั ะฝะฐ ะบะพะฝะบัะตัะฝัะน ะฒะพะฟัะพั. "ะงัะพ ะฑัะดะตั?" โ ัะปะธัะบะพะผ ัะฐะทะผััะพ.

---

ะัะธัะธะฝะฐ 2: ะะต ัะปััะธัั ะพัะฒะตั
ะะฐััะฐ ะฟะพะบะฐะทะฐะปะฐ ะพะดะฝะพ, ะฐ ัั ัะพัะตัั ะดััะณะพะต. ะ ะธะณะฝะพัะธััะตัั.

---

ะะฐะฟะธัะธ ะผะฝะต โ ัะฐะทะฑะตััะผ ัะฒะพะน ะฒะพะฟัะพั ะฟัะฐะฒะธะปัะฝะพ`,

    reels: `ะะฐะฟะธัะธ ะกะฆะะะะะะ ะดะปั Reels/ะฒะธะดะตะพ.
${writingRules}

ะกัััะบัััะฐ:
'ะฅัะบ: [ะฟะตัะฒัะต 3 ัะตะบ โ ะทะฐัะตะฟะธัั]
ะัะฝะพะฒะฐ: [ะณะปะฐะฒะฝะฐั ะผััะปั, 20-30 ัะตะบ]
ะัะธะทัะฒ: [ััะพ ัะดะตะปะฐัั]'

ะะพะฒะพัะธ ะพั ะฟะตัะฒะพะณะพ ะปะธัะฐ. ะะฐะบ ะฑัะดัะพ ัะฝะธะผะฐะตัั ัะฐะผะฐ.`,

    stories: `ะะฐะฟะธัะธ ัะตัะธั ะธะท 4-5 ะกะขะะะะก.
${writingRules}

ะคะพัะผะฐั:
'ะกัะพัะธั 1: [ัะตะบัั ะธะปะธ ะพะฟะธัะฐะฝะธะต]
ะกัะพัะธั 2: [ัะปะตะดัััะธะน ัะปะฐะนะด]...'

ะกัะพัะธั 1 โ ะทะฐัะตะฟะธัั (ะฒะพะฟัะพั, ะธะฝััะธะณะฐ)
ะะพัะปะตะดะฝัั โ ะฟัะธะทัะฒ ะบ ะดะตะนััะฒะธั`
  };

  const callToAction = goal === "sale" 
    ? `ะัะณะบะพ ะฟะพะดะฒะตะดะธ ะบ ะฟัะพะดัะบัั "${product || 'ะบะพะฝััะปััะฐัะธั'}". ะะตะท ะดะฐะฒะปะตะฝะธั, ัะตัะตะท ะฟะพะปัะทั.`
    : "ะะพะฟัะพัะธ ะบะพะผะผะตะฝัะฐัะธะน, ัะตะฐะบัะธั ะธะปะธ ัะพััะฐะฝะตะฝะธะต โ ะตััะตััะฒะตะฝะฝะพ, ะฝะต ะฝะฐะฒัะทัะธะฒะพ.";

  const systemPrompt = `ะขั โ ะบะพะฟะธัะฐะนัะตั ะดะปั ัะทะพัะตัะธัะตัะบะธั ะฟัะฐะบัะธะบะพะฒ. ะะธัะตัั ะถะธะฒัะผ ัะทัะบะพะผ, ะบะฐะบ ะฟะพะดััะณะฐ ะฟะพะดััะณะต. ะะธะบะฐะบะพะณะพ ะพัะธัะธะพะทะฐ.${archetypeInstruction}`;

  const userPrompt = `${formatInstructions[format]}

ะะะจะ: ${niche}
ะขะะ: ${type}
ะะะะฏ: ${idea}
${callToAction}

JSON: {"content": "ะณะพัะพะฒัะน ัะตะบัั", "hashtags": ["#ัะตะณ1", "#ัะตะณ2"]}`;

  try {
    console.log(`Generating ${format} for idea: ${idea.substring(0, 50)}...`);
    const startTime = Date.now();
    
    const response = await getClient().chat.completions.create({
      model: "deepseek-chat",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.7,
      max_tokens: 2000,
    });

    const elapsed = Date.now() - startTime;
    console.log(`${format} generated in ${elapsed}ms`);

    const content = response.choices[0]?.message?.content || "{}";
    const cleaned = cleanJsonResponse(content);
    const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
    
    if (!jsonMatch) {
      throw new Error("Invalid response format");
    }
    
    return JSON.parse(jsonMatch[0]) as FormatContent;
  } catch (error: any) {
    console.error(`${format} generation error:`, error?.message || error);
    throw error;
  }
}
